/*1338860024,169776318*/

if (window.CavalryLogger) { CavalryLogger.start_js(["Cop+r"]); }

__d("CanvasAppRequestUpdater",["Arbiter","CSS","ChannelConstants","DOM","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('CSS'),i=b('ChannelConstants'),j=b('DOM'),k=b('copyProperties');function l(m){this._root=m;g.subscribe(i.getArbiterType('app_request_create'),function(n,o){var p=j.scry(this._root,".item_"+o.obj.appid)[0],q=p&&j.scry(p,".requestsList")[0];q&&j.appendContent(q,o.obj.request);p&&this._updateBookmark(p,1);}.bind(this));g.subscribe(i.getArbiterType('app_request_delete'),function(n,o){var p=j.scry(this._root,".item_"+o.obj.appid)[0],q=p&&j.scry(p,"[data-requestid='"+o.obj.requestid+"']")[0];q&&j.remove(q.parentElement);p&&this._updateBookmark(p,-1);}.bind(this));}k(l.prototype,{_updateBookmark:function(m,n){var o=j.find(m,".flyout"),p=j.find(m,".countValue"),q=parseInt(j.getText(p),10),r=Math.max(0,q+n);j.setContent(p,r);if(r<1){h.hide(p.parentElement);h.hide(o);}else{h.show(p.parentElement);h.show(o);}}});e.exports=l;});
__d("CanvasFlyoutLoader",["AsyncRequest"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h={endpoint:'/ajax/canvas/flyouts',init:function(i,j,k){this.root=i;this.largeApps=j;this.seeAllApps=k;this.handler=Event.listen(i,'mouseenter',this.loadFlyouts.shield(this));},loadFlyouts:function(){this.handler.remove();this.handler=null;var i={items:this.largeApps,all_apps:this.seeAllApps};new g().setURI(this.endpoint).setRelativeTo(this.root).setMethod('post').setReadOnly(true).setData(i).setAllowCrossPageTransition(true).send();}};e.exports=h;});
__d("Dock",["event-extensions","function-extensions","Arbiter","ArbiterMixin","ChatQuietLinks","CSS","DataStore","DOM","Parent","Style","Toggler","Vector","copyProperties","ge"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('ChatQuietLinks'),j=b('CSS'),k=b('DataStore'),l=b('DOM'),m=b('Parent'),n=b('Style'),o=b('Toggler'),p=b('Vector'),q=b('copyProperties'),r=b('ge');function s(){}q(s,h,{MIN_HEIGHT:140,INITIAL_FLYOUT_HEIGHT_OFFSET:10,init:function(t){this.init=bagofholding;this.rootEl=t;this.calculateViewportDimensions();this.calculateFlyoutHeightOffset();i.silence(this.rootEl);Event.listen(t,'click',this._onClick.bind(this));Event.listen(window,'resize',this._onWindowResize.bind(this));o.subscribe(['show','hide'],function(u,v){var w=v.getActive();if(!l.contains(t,w))return;if(j.hasClass(w,'fbNub')){this.notifyNub(w,u);if(u==='show')this._resizeNubFlyout(w);}else{var x=m.byClass(w,'fbNubFlyout');if(x)j.conditionClass(x,'menuOpened',u==='show');}}.bind(this));this.inform('init',{},g.BEHAVIOR_PERSISTENT);},calculateViewportDimensions:function(){return (this.viewportDimensions=p.getViewportDimensions());},calculateFlyoutHeightOffset:function(){this.flyoutHeightOffset=this.INITIAL_FLYOUT_HEIGHT_OFFSET+p.getElementDimensions(this.rootEl).y;var t=r('blueBar');if(t){var u=n.isFixed(t)?'viewport':'document';this.flyoutHeightOffset+=p.getElementPosition(t,u).y+p.getElementDimensions(t).y;}},toggle:function(t){var u=this._findFlyout(t);if(!u)return;this.subscribe('init',function(){o.toggle(t);});},show:function(t){this.subscribe('init',function(){o.show(t);});},showNub:function(t){j.show(t);},hide:function(t){this.subscribe('init',function(){var u=o.getInstance(t);l.contains(t,u.getActive())&&u.hide();});},hideNub:function(t){j.hide(t);this.hide(t);},setUseMaxHeight:function(t,u){j.conditionClass(t,'maxHeight',u!==false);this._resizeNubFlyout(t);},_resizeNubFlyout:function(t){var u=this._findFlyout(t);if(!u||!(j.hasClass(t,'openToggler')||j.hasClass(t,'opened')))return;var v=l.find(u,'div.fbNubFlyoutOuter'),w=l.find(v,'div.fbNubFlyoutInner'),x=l.find(w,'div.fbNubFlyoutBody'),y=x.scrollTop,z=x.offsetHeight;n.set(x,'height','auto');var aa=p.getElementPosition(u,'viewport'),ba=p.getElementDimensions(u),ca=p.getElementDimensions(x),da=Math.max(this.MIN_HEIGHT,this.viewportDimensions.y-this.flyoutHeightOffset)-(this.viewportDimensions.y-aa.y-ba.y);da=Math.max(da,0);n.set(u,'max-height',da+'px');n.set(v,'max-height',da+'px');ba=p.getElementDimensions(u);var ea=p.getElementDimensions(w),fa=ea.y-ca.y;if(ba.y>fa)n.set(x,'height',(ba.y-fa)+'px');j.removeClass(u,'swapDirection');var ga=p.getElementPosition(u).x;j.conditionClass(u,'swapDirection',function(){if(ga<0)return true;return (ga+ba.x>this.viewportDimensions.x);}.bind(this)());if(y+z>=ca.y){x.scrollTop=ca.y;}else x.scrollTop=y;this.notifyNub(t,'resize');},resizeAllFlyouts:function(){var t=l.scry(this.rootEl,'div.fbNub.openToggler');t=t.concat(l.scry(this.rootEl,'div.fbNub.opened'));var u=t.length;while(u--)this._resizeNubFlyout(t[u]);},_onClick:function(event){var t=event.getTarget(),u=m.byClass(t,'fbNub');if(u){if(m.byClass(t,'fbNubFlyoutTitlebar')){var v=m.byTag(t,'a');if(!v){this.hide(u);return false;}}this.notifyNub(u,'click');}},_onWindowResize:function(event){this.calculateViewportDimensions();this.resizeAllFlyouts();},_findFlyout:function(t){return j.hasClass(t,'fbNubFlyout')?t:l.scry(t,'div.fbNubFlyout')[0]||null;},registerNubController:function(t,u){k.set(t,'dock:nub:controller',u);u.subscribe('nub/button/content-changed',this.inform.shield(this,'resize',t));u.subscribe('nub/flyout/content-changed',this._resizeNubFlyout.shield(this,t));},unregisterNubController:function(t){k.remove(t,'dock:nub:controller');},notifyNub:function(t,u,v){var w=k.get(t,'dock:nub:controller');w&&w.inform(u,v);}});e.exports=a.Dock||s;});
__d("legacy:dock",["Dock"],function(a,b,c,d){a.Dock=b('Dock');},3);
__d("NubController",["ArbiterMixin","Class","Dock","copyProperties"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('Class'),i=b('Dock'),j=b('copyProperties');function k(){}j(k.prototype,g,{init:function(l){this.el=l;i.registerNubController(l,this);return this;},buttonContentChanged:function(){this.inform('nub/button/content-changed');},flyoutContentChanged:function(){this.inform('nub/flyout/content-changed');},hide:function(){i.hide(this.el);},show:function(){i.show(this.el);}});e.exports=k;});
__d("ChatActivity",["Arbiter","AvailableList","AvailableListConstants","ChatConfig","copyProperties","event-extensions","JSLogger","math-extensions","MercuryThreads","PresenceState","UserActivity"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AvailableList'),i=b('AvailableListConstants'),j=b('ChatConfig'),k=b('copyProperties');b('event-extensions');var l=b('JSLogger'),m=b('math-extensions'),n=b('MercuryThreads'),o=b('PresenceState'),p=b('UserActivity'),q=j.get('activity_limit')||60000,r=j.get('idle_limit')||1800000,s=j.get('idle_poll_interval')||300000,t=l.create('chat_activity'),u=Date.now(),v=u,w=true;function x(){var ba=Date.now();return !!(w&&(ba-u<q));}var y=k(new g(),{isActive:x});function z(){var ba=u;u=Date.now();if(u-ba>r){t.debug('idle_to_active',ba);o.doSync();}y.inform('activity');}h.subscribe(i.ON_AVAILABILITY_CHANGED,function(){if(!h.isUserIdle())v=Date.now();});Event.listen(window,'focus',function(){w=true;z();});Event.listen(window,'blur',function(){w=false;});p.subscribe(function(){z();});function aa(ba){var ca=ba&&ba.at&&m.verifyNumber(ba.at);if(typeof ca!=='number')ca=null;return ca||0;}setInterval(function(){var ba=Date.now(),ca=aa(o.get()),da=Math.max(u,ca,v);if(ba-da>r){t.debug('idle',{cookie:ca,local:u,presence:v});y.inform('idle',ba-da);}},s);o.registerStateStorer(function(ba){var ca=aa(ba);if(ca<u)ba.at=u;return ba;});g.subscribe(l.DUMP_EVENT,function(ba,ca){ca.chat_activity={activity_limit:q,idle_limit:r,idle_poll_interval:s,last_active_time:u,last_global_active_time:v};});e.exports=y;});
__d("ChatTabPresence",["Arbiter","AvailableList","ChatTabModel","MercuryThreads"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AvailableList'),i=b('ChatTabModel'),j=b('MercuryThreads'),k={};function l(m){var n=j.getCanonicalUserInThread(m);if(n)h.updateForID(n);}i.subscribe('chat/tabs-changed',function(event,m){m.tabs.forEach(function(n){if(n.raised&&!k[n.id])l(n.id);});k={};m.tabs.forEach(function(n){if(n.raised)k[n.id]=true;});});e.exports={};});
__d("ChatTabViewSelector",["Arbiter","copyProperties","CSS","DataStore","DOM","Menu","MercuryThreadInformer","MercuryThreads","NubController","MercuryThreadMetadataRenderer","Toggler","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('CSS'),j=b('DataStore'),k=b('DOM'),l=b('Menu'),m=b('MercuryThreadInformer'),n=b('MercuryThreads'),o=b('NubController'),p=b('MercuryThreadMetadataRenderer'),q=b('Toggler'),r=c('ChatTabTemplates');function s(t){var u=r[':fb:chat:tab:selector'].build(),v=u.getRoot(),w=u.getNode('menu'),x=k.find(w,'.uiMenuInner'),y={},z=new o().init(v);i.hide(v);k.insertBefore(t,v);function aa(da){var ea=0;for(var fa in y){var ga=y[fa],ha=n.getThreadMetaNow(fa),ia=ga.getNode('unreadCount'),ja=(ha&&ha.unread_count)||0;ea+=ja;if(ja>9)ja='+';i.conditionClass(ia,'invisible_elem',!ja);k.setContent(ia,ja);}var ka=u.getNode('numMessages');i.conditionShow(ka,ea);k.setContent(ka,ea);}this.setTabData=function(da){y={};if(da.length<1){i.hide(v);return;}i.show(v);k.empty(x);da.forEach(function(ea){var fa=r[':fb:chat:tab:selector:item'].build();y[ea.id]=fa;var ga=fa.getNode('content');p.renderAndSeparatedParticipantList(ea.id,ga);k.prependContent(x,fa.getRoot());j.set(fa.getRoot(),'threadID',ea.id);});z.flyoutContentChanged();k.setContent(u.getNode('numTabs'),da.length);aa();};function ba(event,da){if(da.menu!=w)return;var ea=j.get(da.item,'threadID');s.inform('selected',ea);q.hide(v);}function ca(event,da){l.register(w);}l.subscribe('select',ba.bind(this));q.listen('show',v,function(){g.inform('layer_shown',{type:'ChatTabSelector'});ca();});q.listen('hide',v,function(){g.inform('layer_hidden',{type:'ChatTabSelector'});});m.subscribe('threads-updated',aa);}h(s,new g());e.exports=s;});
__d("Sound",["SoundPlayer","SoundRPC","SoundSynchronizer","UserAgent"],function(a,b,c,d,e,f){var g=b('SoundPlayer'),h=b('SoundRPC'),i=b('SoundSynchronizer'),j=b('UserAgent'),k=null,l={init:function(o){if(!k)g.init(o);},play:function(o,p,q){if(k){h.playRemote(k.contentWindow,o,p,false);}else h.playLocal(o,p,q);},stop:function(o){if(!k)g.stop(o);}},m=location.host.replace(/^[^.]+/,'www');function n(){if(j.ie()<9)return false;return i.isSupported()&&h.supportsRPC();}if(location.host!==m&&n()){k=document.createElement('iframe');k.setAttribute('src','//'+m+'/sound_iframe.php');k.style.display='none';document.body.appendChild(k);}e.exports=l;});
__d("ChatSound",["ChatOptions","MercuryParticipants","Sound"],function(a,b,c,d,e,f){var g=b('ChatOptions'),h=b('MercuryParticipants'),i=b('Sound');i.init(['audio/ogg','audio/mpeg']);function j(k){i.play(['/sound/pling.ogg','/sound/pling.mp3'],k,false);}e.exports={messageReceived:function(k){if(g.getSetting('sound')&&k.sender!=h.user)j(k.timestamp);}};});
__d("VideoCallPromo",["ArbiterMixin","AsyncRequest","AvailableList","AvailableListConstants","ChatConfig","ChatVisibility","ContextualDialogX","copyProperties","CSS","MercuryThreads","MercuryParticipants","VideoCallCore","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('AsyncRequest'),i=b('AvailableList'),j=b('AvailableListConstants'),k=b('ChatConfig'),l=b('ChatVisibility'),m=b('ContextualDialogX'),n=b('copyProperties'),o=b('CSS'),p=b('MercuryThreads'),q=b('MercuryParticipants'),r=c('ChatTabTemplates'),s=b('VideoCallCore');function t(){this._dialog=null;}function u(w){if(!(s.isSupported()&&k.get('video.show_promo')))return false;var x=p.getCanonicalUserInThread(w);if(!x)return false;return l.isOnline()&&s.availableForCall(x);}function v(w){new h().setURI('/ajax/chat/video/log_promo.php').setData({viewedUserID:w}).setAllowCrossPageTransition(true).setErrorHandler(bagofholding).send();}n(t.prototype,g);n(t.prototype,{render:function(w,x){var y=u(x);if(!y)return;var z=p.getCanonicalUserInThread(x);q.get('fbid:'+z,function(aa){if(!aa.call_promo)return;var ba=r[':fb:mercury:call:promo'].build();this._dialog=new m();this._dialog.init(ba.getRoot()).setWidth(250).setAlignH('center').setContext(w).show();o.addClass(this._dialog.getRoot(),'uiContextualDialogWithFooterArrowBottom');o.addClass(w,'video_call_promo');v(p.getCanonicalUserInThread(x));this.inform('chat/dialog-rendered',{dialog:this,thread_id:x});}.bind(this));},updatePosition:function(){if(this._dialog&&this._dialog.isShown())this._dialog.updatePosition();},hide:function(){if(this._dialog&&this._dialog.isShown()){this._dialog.hide();this._dialog=null;}}});e.exports=t;});
__d("VideoCallTourDialog",["ArbiterMixin","ContextualDialogX","copyProperties","CSS","MercuryThreads","VideoCallCore","VideoCallingTour","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('ContextualDialogX'),i=b('copyProperties'),j=b('CSS'),k=b('MercuryThreads'),l=c('ChatTabTemplates'),m=b('VideoCallCore'),n=b('VideoCallingTour');function o(){this._dialog=null;}i(o.prototype,g);i(o.prototype,{render:function(p,q){var r=k.getCanonicalUserInThread(q);if(!r||!m.availableForCall(r))return;var s=l[':fb:mercury:call:tour'].build();this._dialog=new h();this._dialog.init(s.getRoot()).setWidth(250).setAlignH('center').setContext(p).show();j.addClass(this._dialog.getRoot(),'uiContextualDialogWithFooterArrowBottom');j.addClass(p,'video_call_tour');this.inform('chat/dialog-rendered',{dialog:this,thread_id:q});n.inform('videocallingtour/end');},updatePosition:function(){if(this._dialog&&this._dialog.isShown())this._dialog.updatePosition();},hide:function(){if(this._dialog&&this._dialog.isShown()){this._dialog.hide();this._dialog=null;}}});e.exports=o;});
__d("ChatContextualDialogController",["ArbiterMixin","ChatTabModel","copyProperties","setTimeoutAcrossTransitions","VideoCallPromo","VideoCallingTour","VideoCallTourDialog"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('ChatTabModel'),i=b('copyProperties'),j=b('setTimeoutAcrossTransitions'),k=b('VideoCallPromo'),l=b('VideoCallingTour'),m=b('VideoCallTourDialog'),n=60000,o=false,p=false,q=function(x,y){this._videoCallPromo=new k();this._videoCallTour=new m();this._threadID=x;this._tabMainElement=y;this._openDialog=null;this._subscriptionTokens=[];this._scrollListener=null;this._timeout=null;};function r(x,event,y){if(x._openDialog)x._openDialog.updatePosition();}function s(x){if(x._openDialog)x._openDialog.updatePosition();}function t(x){if(x._openDialog){x._openDialog.hide();x._openDialog=null;}if(x._timeout){clearTimeout(x._timeout);x._timeout=null;}while(x._subscriptionTokens.length)x._subscriptionTokens.pop().unsubscribe();if(x._scrollListener){x._scrollListener.remove();x._scrollListener=null;}}function u(x,event,y){if(y.thread_id===x._threadID){x._openDialog=y.dialog;o=true;w(x);x._timeout=j(x.destroy.bind(x,x._threadID),n);x._scrollListener=Event.listen(window,'scroll',s.curry(x));}}function v(x,y){if(!x._openDialog){x._subscriptionTokens.push(y.subscribe('chat/dialog-rendered',u.curry(x)));y.render(x._tabMainElement,x._threadID);}}function w(x){x._subscriptionTokens.push(h.subscribe('chat/tabs-changed',r.curry(x)),q.subscribe('dialog/close-all',t.curry(x)));}i(q,g);i(q.prototype,{destroy:function(){t(this);},tabFocused:function(){if(p){v(this,this._videoCallTour);return;}if(!o)v(this,this._videoCallPromo);},tabNotActive:function(){t(this);},hideVideoCallouts:function(){t(this);}});l.subscribe('videocallingtour/start',function(){p=true;q.inform('dialog/close-all');});l.subscribe('videocallingtour/end',function(){p=false;});e.exports=q;});
__d("ChatPrivacyActionController",["Arbiter","ChatVisibility","JSLogger","PresencePrivacy","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChatVisibility'),i=b('JSLogger'),j=b('PresencePrivacy'),k=b('copyProperties'),l=function(m,n){this._userID=m;this._logger=i.create('blackbird');this._getState=function(){if(h.isOnline())return j.allows(this._userID)?l.NORMAL:l.BLOCKED;return l.OFFLINE;};this._togglePrivacy=function(){var o=this._getState();switch(this._getState()){case l.OFFLINE:if(h.isOnline()){this._logger.error('tabs_already_online');break;}this._logger.log('tabs_go_online',{tab_id:this._userID});h.goOnline(function(){if(!j.allows(this._userID)){if(this._getState()!==l.BLOCKED)this._logger.error('privacy_action_controller_blocked_inconsistency');this._togglePrivacy();}}.bind(this));break;case l.BLOCKED:j.allow(this._userID);this._logger.log('tabs_unblock',{tab_id:this._userID});break;case l.NORMAL:j.disallow(this._userID);this._logger.log('tabs_block',{tab_id:this._userID});break;}};(function(){var o=function(){n&&n(this._getState());}.bind(this);o();j.subscribe('privacy-changed',o);}.bind(this)).defer();};l.OFFLINE='offline';l.BLOCKED='blocked';l.NORMAL='normal';k(l.prototype,{togglePrivacy:function(){this._logger.log('gear_menu_toggle_privacy',{tab_id:this._userID});this._togglePrivacy();}});e.exports=l;});
__d("ChatTabEmoticonView",["event-extensions","function-extensions","DOM","InputSelection","Parent","TextAreaControl","Toggler","copyProperties","endsWith","startsWith"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('DOM'),h=b('InputSelection'),i=b('Parent'),j=b('TextAreaControl'),k=b('Toggler'),l=b('copyProperties'),m=b('endsWith'),n=b('startsWith'),o={smile:':)',frown:':(',tongue:':P',grin:'=D',gasp:':o',wink:';)',glasses:'8)',sunglasses:'B|',grumpy:'>:(',unsure:':/',cry:":'(",devil:'3:)',angel:'O:)',kiss:':*',heart:'<3',kiki:'^_^',squint:'-_-',confused:'o.O',upset:'>:o',pacman:':v',robot:':|]',colonthree:':3',penguin:"<(\')",putnam:':putnam:',shark:'(^^^)','42':':42:',like:'(y)'};function p(r,s,t){var u=i.byClass(r,'emoteIcon');if(!u)return;var v='name_',w=null;u.className.split(' ').forEach(function(da){if(n(da,v))w=da.substring(v.length);});if(!o[w])return;var x=j.getInstance(s),y=x.getValue(),z=o[w],aa=y.substring(0,t.start),ba=y.substring(t.end);if(t.start>0&&!m(aa,' '))z=' '+z;if(!n(ba,' '))z+=' ';var ca=aa+z+ba;t.start+=z.length;t.end=t.start;x.setValue(ca);h.set(s,t.start,t.end);}function q(r,s){var t={start:0,end:0};function u(){t=h.get(s);}var v=g.find(r,'.uiToggleFlyout');this._eventListeners=[Event.listen(v,'click',function(event){k.hide(r);p(event.getTarget(),s,t);}),Event.listen(s,'keyup',u),Event.listen(s,'click',u)];}l(q.prototype,{destroy:function(){while(this._eventListeners.length)this._eventListeners.pop().remove();}});e.exports=q;});
__d("MercuryLiveListenMessageRenderer",["CSS","DOM","Env","JSLogger","MercuryConstants"],function(a,b,c,d,e,f){var g=b('CSS'),h=b('DOM'),i=b('Env'),j=b('JSLogger'),k=c('MercuryConstants'),l=k.MusicLiveListenCommands,m=j.create('live_listen_renderer');function n(u,v){return h.$N('a',{href:u},v);}function o(u){var v=u.actor;if(v.id==i.user){return h.tx._("You are now listening to music with {name}.",{name:n(v.leader_profile_url,v.leader_name)});}else if(v.leader_id==i.user)return h.tx._("{name} is listening to music with you.",{name:n(v.url,v.name)});}function p(u){var v=u.actor,w=n(v.url,v.name),x=n(v.leader_profile_url,v.leader_name),y=v.action===l.LISTENER_ADD,z=i.user==v.id,aa=i.user==v.leader_id;if(y){if(z){return h.tx._("You are now listening to music with {name}.",{name:x});}else return h.tx._("{name} started listening.",{name:w});}else if(v.leader_id==v.id&&!aa){return h.tx._("{name} left the conversation. You will no longer hear the songs they play.",{name:x});}else if(z&&v.id!=v.leader_id){return h.tx._("You are no longer listening to music with {name}.",{name:x});}else if(!z){return h.tx._("{name} stopped listening.",{name:w});}else return '';}function q(u){return h.$N('span',{},[h.$N('strong',{},u.title),h.$N('br'),u.body]);}function r(){var u=null;if(a.MusicLiveListen){var v=a.MusicLiveListen.getInstance().getCurrentSession();u=v&&v.provider_name;}return u||'Spotify';}function s(u){var v=r(),w=n(u.url,u.title);w.target='_blank';var x=n(u.artist_url,u.artist);return h.tx._("{title} by {artist} on {provider}",{title:w,artist:x,provider:v});}var t={getIconSpriteClass:function(u){var v=u.log_message_data;if(v)switch(v.music_type){case 'begin_session':return 'addActionIcon';case 'listener_update':if(v.actor)if(v.actor.action===l.LISTENER_ADD){return 'addActionIcon';}else return 'leaveActionIcon';break;case 'song':return 'songIcon';case 'play_error':return 'playErrorIcon';}m.error('bad_message',u);return null;},getLogMessageText:function(u){var v=u.log_message_data;if(v)switch(v.music_type){case 'begin_session':return o(v);case 'listener_update':return p(v);case 'song':return s(v);case 'play_error':return q(v);}m.error('bad_message',u);return '';}};e.exports=t;});
__d("MercuryMessageRenderer",["CSS","DOM","Emote","HTML","htmlHyperlink","MercuryLiveListenMessageRenderer","MercuryParticipants","tx","MercuryConstants"],function(a,b,c,d,e,f){var g=b('CSS'),h=b('DOM'),i=b('Emote'),j=b('HTML'),k=b('htmlHyperlink'),l=b('MercuryLiveListenMessageRenderer'),m=b('MercuryParticipants'),n=c('MercuryConstants'),o=b('tx'),p={renderLogMessage:function(ca,da,ea){q(ca,ea);r(da,ea);},formatMessageBody:function(ca){ca=(ca||'').replace(/\n+$/,'');ca=k(ca,i.htmlEmote,null,true);return j(ca);}};function q(ca,da){var ea='';switch(da.log_message_type){case n.MercuryLogMessageType.SUBSCRIBE:ea='MercurySubscribeIcon';break;case n.MercuryLogMessageType.UNSUBSCRIBE:ea='MercuryUnsubscribeIcon';break;case n.MercuryLogMessageType.THREAD_NAME:ea='MercuryThreadNameIcon';break;case n.MercuryLogMessageType.THREAD_IMAGE:ea='MercuryThreadImageIcon';break;case n.MercuryLogMessageType.VIDEO_CALL:var fa=da.log_message_data.answered;if(fa||ba(da)){ea='MercuryVideoCallIcon';}else ea='MercuryMissedVideoCallIcon';break;case n.MercuryLogMessageType.SERVER_ERROR:ea='MercuryErrorIcon';break;case n.MercuryLogMessageType.LIVE_LISTEN:ea=l.getIconSpriteClass(da);break;}g.addClass(ca,ea);}function r(ca,da){switch(da.log_message_type){case n.MercuryLogMessageType.SUBSCRIBE:y(ca,da);break;case n.MercuryLogMessageType.UNSUBSCRIBE:z(ca,da);break;case n.MercuryLogMessageType.VIDEO_CALL:if(ba(da)){s(ca,da);}else t(ca,da);break;case n.MercuryLogMessageType.THREAD_NAME:u(ca,da);break;case n.MercuryLogMessageType.THREAD_IMAGE:v(ca,da);break;case n.MercuryLogMessageType.SERVER_ERROR:aa(ca,da);break;case n.MercuryLogMessageType.LIVE_LISTEN:var ea=l.getLogMessageText(da);if(ea)h.setContent(ca,ea);break;}}var s=function(ca,da){m.get(da.author,function(ea){var fa=ea.short_name,ga;switch(da.log_message_data.event_name){case 'installing':ga=h.tx._("{firstname} is setting up video calling...",{firstname:fa});break;case 'installed':ga=h.tx._("{firstname} finished setting up video calling.",{firstname:fa});break;case 'install_canceled':ga=h.tx._("You canceled the video calling installation. ",{firstname:fa});break;}if(ga)h.setContent(ca,ga);});},t=function(ca,da){var ea=da.log_message_data.caller,fa=da.log_message_data.callee,ga=[ea,fa];m.getMulti(ga,function(ha){if(ea==m.user){var ia=ha[fa].short_name;if(da.log_message_data.answered){message_text=h.tx._("You called {firstname}.",{firstname:ia});}else message_text=h.tx._("{firstname} missed a call from you. ",{firstname:ia});}else{var ja=ha[ea].short_name;if(da.log_message_data.answered){message_text=h.tx._("{firstname} called you.",{firstname:ja});}else message_text=h.tx._("You missed a call from {firstname}. ",{firstname:ja});}h.setContent(ca,message_text);});},u=function(ca,da){var ea=da.log_message_data.name,fa=h.$N('b',{},ea);if(da.author==m.user){if(ea){h.setContent(ca,h.tx._("You named the conversation: {name}.",{name:fa}));}else h.setContent(ca,h.tx._("You removed the conversation name."));}else m.get(da.author,function(ga){var ha,ia=w(ga);if(ea){ha=h.tx._("{actor} named the conversation: {name}.",{actor:ia,name:fa});}else ha=h.tx._("{actor} removed the conversation name.",{actor:ia});h.setContent(ca,ha);});},v=function(ca,da){if(da.author==m.user){if(da.log_message_data.image){h.setContent(ca,h.tx._("You changed the conversation picture."));}else h.setContent(ca,h.tx._("You removed the conversation picture."));}else m.get(da.author,function(ea){var fa=w(ea),ga;if(da.log_message_data.image){ga=h.tx._("{actor} changed the conversation picture.",{actor:fa});}else ga=h.tx._("{actor} removed the conversation picture.",{actor:fa});h.setContent(ca,ga);});},w=function(ca){if(ca.href)return h.$N('a',{href:ca.href},ca.name);return ca.name;},x=function(ca){if(ca.href)return h.$N('a',{href:ca.href},ca.short_name);return ca.short_name;},y=function(ca,da){var ea=da.log_message_data.added_participants,fa=null,ga;if(ea.length==1){fa=[da.author,ea[0]];m.getMulti(fa,function(ha){if(da.author==m.user){ga=h.tx._("You added {subscriber1}.",{subscriber1:w(ha[ea[0]])});}else ga=h.tx._("{actor} added {subscriber1}.",{actor:w(ha[da.author]),subscriber1:w(ha[ea[0]])});h.setContent(ca,ga);});}else if(ea.length==2){fa=[da.author].concat(ea.slice(0,2));m.getMulti(fa,function(ha){if(da.author==m.user){ga=h.tx._("You added {subscriber1} and {subscriber2}.",{subscriber1:w(ha[ea[0]]),subscriber2:w(ha[ea[1]])});}else ga=h.tx._("{actor} added {subscriber1} and {subscriber2}.",{actor:w(ha[da.author]),subscriber1:w(ha[ea[0]]),subscriber2:w(ha[ea[1]])});h.setContent(ca,ga);});}else{fa=[da.author].concat(ea.slice(0,2));m.getMulti(fa,function(ha){if(da.author==m.user){ga=h.tx._("You added {subscriber1}, {subscriber2} and {more_people}.",{subscriber1:w(ha[ea[0]]),subscriber2:w(ha[ea[1]]),more_people:ea.length-2});}else ga=h.tx._("{actor} added {subscriber1}, {subscriber2} and {more_people}.",{actor:w(ha[da.author]),subscriber1:w(ha[ea[0]]),subscriber2:w(ha[ea[1]]),more_people:ea.length-2});h.setContent(ca,ga);});}},z=function(ca,da){m.get(da.author,function(ea){h.setContent(ca,h.tx._("{actor} left the conversation.",{actor:w(ea)}));});},aa=function(ca,da){var ea="We were unable to fetch previous messages in this conversation.";h.setContent(ca,ea);},ba=function(ca){return ca.log_message_data.event_name==='installing'||ca.log_message_data.event_name==='install_canceled';};e.exports=p;});
__d("MercuryAttachmentRenderer",["CSS","DOM","MercuryAttachment","MercuryAttachmentTemplates","MercuryConstants"],function(a,b,c,d,e,f){var g=b('CSS'),h=b('DOM'),i=b('MercuryAttachment'),j=c('MercuryAttachmentTemplates'),k=c('MercuryConstants'),l={renderError:function(m){var n=j[':fb:mercury:attachment:error'].build();h.appendContent(n.getNode('error'),m.error_msg);return n.getRoot();},renderExternalLink:function(m){var n=j[':fb:mercury:attachment:external-link'].build().setNodeContent('name',m.name).setNodeContent('shortLink',m.base_url),o=n.getNode('preview-link');o.setAttribute('href',m.url);m.rel&&o.setAttribute('rel',m.rel);n.getNode('preview-image').setAttribute('src',m.preview_url);n.getNode('name').setAttribute('href',m.url);g.addClass(n.getNode('preview'),m.preview_class);return n.getRoot();},renderFileLink:function(m){var n=j[':fb:mercury:attachment:file-link'].build().setNodeContent('filename',m.name),o=n.getNode('link');o.setAttribute('href',m.url);m.rel&&o.setAttribute('rel',m.rel);g.addClass(n.getRoot(),i.getAttachIconClass(m.icon_type));return n.getRoot();},renderMusic:function(m){var n=j[':fb:mercury:attachment:music'].build().setNodeContent('filename',m.name),o=n.getNode('link');o.setAttribute('href',m.url);o.setAttribute('target','_blank');m.rel&&o.setAttribute('rel',m.rel);var p=n.getNode('preview-link');p.setAttribute('href',m.url);m.rel&&p.setAttribute('rel',m.rel);n.getNode('preview-image').setAttribute('src',m.preview_url);g.addClass(n.getNode('icon_link'),'MercuryMusicIcon');return n.getRoot();},renderPreview:function(m){var n=j[':fb:mercury:attachment:preview'].build(),o=n.getNode('preview-link');o.setAttribute('href',m.url);m.rel&&o.setAttribute('rel',m.rel);n.getNode('preview-image').setAttribute('src',m.preview_url);g.addClass(n.getRoot(),m.preview_class);return n.getRoot();},renderShareLink:function(m){var n=j[':fb:mercury:attachment:share-link'].build().setNodeContent('name',m.name),o=n.getNode('link');o.setAttribute('href',m.url);m.rel&&o.setAttribute('rel',m.rel);return n.getRoot();},renderVideoThumb:function(m){var n=j[':fb:mercury:attachment:video-thumb'].build(),o=n.getNode('thumb');o.setAttribute('href',m.url);o.setAttribute('rel',m.rel);var p=h.find(n.getRoot(),'img');p.src=m.preview_url;return n.getRoot();}};e.exports=l;});
__d("MercuryMessages",["Arbiter","copyProperties","Env","JSLogger","math-extensions","tx","KeyedCallbackManager","MercuryAssert","MercuryParticipants","PresenceUtil","RangedCallbackManager","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('Env'),j=b('JSLogger'),k=b('math-extensions'),l=b('tx'),m=b('KeyedCallbackManager'),n=b('MercuryAssert'),o=b('MercuryParticipants'),p=b('PresenceUtil'),q=b('RangedCallbackManager'),r=b('MercuryServerRequests'),s=b('MercuryThreadInformer'),t=b('MercuryThreads'),u=c('MercuryConstants'),v={},w={},x={},y=function(ia){var ja=ia;if(w[ia])ja=w[ia];return v[ja];},z={};function aa(ia){ia.message_id=ia.message_id||ga.generateNewClientMessageID(ia.timestamp);var ja=o.user;ia.specific_to_list=ia.specific_to_list||[];if(ia.specific_to_list.length&&ia.specific_to_list.indexOf(ja)===-1)ia.specific_to_list.push(ja);if(!ia.thread_id){if(ia.specific_to_list.length==1){ia.thread_id='user:'+i.user;}else if(ia.specific_to_list.length==2){var ka=ia.specific_to_list[0]==ja?ia.specific_to_list[1]:ia.specific_to_list[0],la=ka.indexOf(':');if(ka.substr(0,la)=='fbid')ia.thread_id='user:'+ka.substr(la+1);}ia.thread_id=ia.thread_id||'root:'+ia.message_id;}if(!ia.specific_to_list.length){var ma=r.tokenizeThreadID(ia.thread_id);if(ma.type=='user')ia.specific_to_list=['fbid:'+ma.value,ja];}}function ba(ia,ja,ka){var la=(new Date()).getTime(),ma={action_type:ia,thread_id:ka,author:o.user,timestamp:la,timestamp_absolute:(new Date(la)).toLocaleString(),timestamp_relative:"a few seconds ago",is_unread:false,is_cleared:false,is_forward:false,source:ja};return ma;}function ca(ia){switch(ia){case u.MercuryPayloadSource.UNKNOWN:case u.MercuryPayloadSource.SERVER_INITIAL_DATA:case u.MercuryPayloadSource.SERVER_FETCH_THREAD_INFO:case u.MercuryPayloadSource.SERVER_THREAD_SYNC:return true;}return false;}function da(ia){return ia&&ia.substr(0,6)==='server';}function ea(ia){if(!z[ia])z[ia]=new q(function(ja){return y(ja).timestamp;},function(ja,ka){return ka-ja;});return z[ia];}g.subscribe(j.DUMP_EVENT,function(ia,ja){var ka={};for(var la in v){var ma=v[la],na=ma.thread_id;ka[na]=ka[na]||{};ka[na][ma.message_id]=h({},ma);}ja.messaging=ja.messaging||{};ja.messaging.local_message_ids=h({},w);ja.messaging.messages=ka;});function fa(ia){ia.forEach(function(ja){var ka=ea(ja);ka.setReachedEndOfArray();});}var ga={getMessagesFromIDs:function(ia){return (ia||[]).map(y).filter(function(ja){return ja;});},getThreadMessagesRange:function(ia,ja,ka,la){var ma=ea(ia),na=function(ra){la(ha(ra));},oa=ma.executeOrEnqueue(ja,ka,na),pa=ma.getUnavailableResources(oa),qa=x[ia];if(pa.length&&!qa){r.fetchThreadMessages(ia,ja,ka);}else x[ia]=false;return oa;},getThreadMessagesSinceTimestamp:function(ia,ja){var ka=ea(ia),la=ka.getElementsUntil(ja);return ha(la);},unsubscribe:function(ia,ja){n.isThreadID(ja);var ka=ea(ja);ka.unsubscribe(ia);},handleUpdates:function(ia,ja,ka){var la={},ma={},na=u.MercuryActionStatus;for(var oa=0;oa<ia.length;oa++){var pa=ia[oa];if(pa.is_forward){if(!v[pa.message_id])v[pa.message_id]=pa;continue;}var qa=pa.action_type;if(qa==u.MercuryActionType.SEND_MESSAGE){var ra=pa.client_message_id;if(ra&&w[ra]&&pa.status){if(pa.status==na.UNCONFIRMED){if(!ma[pa.thread_id])ma[pa.thread_id]=[];ma[pa.thread_id].push(pa.client_message_id);}else if(!la[pa.thread_id])la[pa.thread_id]=[];var sa=y(pa.client_message_id),ta=sa.status;sa.status=pa.status;if(pa.status==na.SUCCESS)this.updateLocalMessage(pa,ka);if(typeof ta!='undefined'||pa.status==na.REQUEST_ERROR||pa.status==na.TRANSPORT_ERROR||pa.status==na.FAILED_UNKNOWN_REASON||pa.status==na.UNABLE_TO_CONFIRM||pa.status==na.RESENT)s.updatedMessage(pa.thread_id,y(pa.client_message_id).message_id,ka);}continue;}else if(qa==u.MercuryActionType.USER_GENERATED_MESSAGE){if(pa.status==na.RESENDING)s.updatedMessage(pa.thread_id,pa.message_id,ka);}else if(qa==u.MercuryActionType.DELETE_THREAD){ea(pa.thread_id).removeAllResources();continue;}else if(qa==u.MercuryActionType.LOG_MESSAGE){if(pa.log_message_type==u.MercuryLogMessageType.SERVER_ERROR)x[pa.thread_id]=true;}else if(qa==u.MercuryActionType.CLEAR_CHAT){var ua=ea(pa.thread_id).getAllResources();ua.map(y).forEach(function(bb){bb.is_cleared=true;});continue;}var va=y(pa.message_id);if((pa.threading_id&&w[pa.threading_id])||(va&&!va.is_forward))continue;if(!la[pa.thread_id])la[pa.thread_id]=[];la[pa.thread_id].push(pa.message_id);v[pa.message_id]=pa;if(!ja)s.receivedMessage(pa);}for(var wa in la){var xa=ea(wa),ya=xa.getAllResources(),za=ya.filter(function(bb){var cb=v[bb];return cb.action_type==u.MercuryActionType.LOG_MESSAGE&&cb.log_message_type==u.MercuryLogMessageType.SERVER_ERROR;});xa.removeResources(za);if(ja){xa.addResources(la[wa]);s.reorderedMessages(wa,ka);}else xa.addResourcesWithoutSorting(la[wa].reverse(),0);s.updatedThread(wa);}var ab=Object.keys(ma);if(ab.length)r.requestMessageConfirmation(ma);},sendMessage:function(ia){aa(ia);w[ia.message_id]=ia.message_id;s.synchronizeInforms(function(){this.handleUpdates([ia],false,u.MercuryPayloadSource.CLIENT_SEND_MESSAGE);r.sendNewMessage(ia);}.bind(this));return ia.thread_id;},resendMessage:function(ia){var ja=h({},ia);ja.status=u.MercuryActionStatus.RESENDING;ja.timestamp=(new Date()).getTime();ja.message_id=ga.generateNewClientMessageID(ja.timestamp);y(ia.message_id).status=u.MercuryActionStatus.RESENT;this.sendMessage(ja);},deleteMessages:function(ia){},updateLocalMessage:function(ia,ja){var ka=ia.message_id,la=ia.client_message_id;w[la]=ka;v[ka]=v[la];v[la]={};if(ia.timestamp)y(la).timestamp=ia.timestamp;if(ia.attachments&&ia.attachments.length){y(la).raw_attachments=null;y(la).attachments=ia.attachments;s.updatedMessage(ia.thread_id,y(la).message_id,ja);}},constructUserGeneratedMessageObject:function(ia,ja,ka,la){var ma=ba(u.MercuryActionType.USER_GENERATED_MESSAGE,ja,ka);ma.body=ia;ma.has_attachment=false;ma.is_html=false;ma.attachments=[];ma.specific_to_list=la||[];return ma;},constructLogMessageObject:function(ia,ja,ka,la){var ma=ba(u.MercuryActionType.LOG_MESSAGE,ia,ja);ma.log_message_type=ka;ma.log_message_data=la;return ma;},generateNewClientMessageID:function(ia){var ja=ia+':'+(k.rand32()+1)+'-'+p.getSessionID();return '<'+ja+'@mail.projektitan.com>';}};r.subscribe('update-messages',function(ia,ja){var ka=(ja.actions||[]).filter(function(ma){var na=ma.action_type;return (ma.is_forward||ma.thread_id)&&(na==u.MercuryActionType.LOG_MESSAGE||na==u.MercuryActionType.USER_GENERATED_MESSAGE||na==u.MercuryActionType.SEND_MESSAGE||na==u.MercuryActionType.CLEAR_CHAT||na==u.MercuryActionType.DELETE_THREAD);}),la=ca(ja.payload_source);if(da(ja.payload_source))ka.forEach(function(ma){if(!ma.is_forward){var na=t.getThreadMetaNow(ma.thread_id);if(na)ma.is_cleared=ma.timestamp<na.chat_clear_time;}});ga.handleUpdates(ka,la,ja.payload_source);if(ja.end_of_history)fa(ja.end_of_history);});function ha(ia){var ja=ia.map(y);return ja.reverse();}e.exports=ga;});
__d("MercuryRoger",["ArbiterMixin","MercuryServerRequests","LiveTimer","copyProperties"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('MercuryServerRequests'),i=b('LiveTimer'),j=b('copyProperties'),k={},l={getSeenBy:function(m){if(!m)return [];var n=[],o=k[m.thread_id];for(var p in o)if(o[p]>m.timestamp&&p!=m.author)n.push(p);return n;},getSeenTimestamp:function(m,n){var o=k[m];return o?o[n]:null;}};j(l,g);h.subscribe('update-roger',function(m,n){for(var o in n){if(!k[o])k[o]={};for(var p in n[o]){var q=k[o][p],r=n[o][p];if(!q||r>q)k[o][p]=r;}}if(n)l.inform('state-changed',n);});e.exports=l;});
__d("ChatTabMessagesView",["Arbiter","ArbiterMixin","Bootloader","ChannelConstants","ChatVisibility","ChatConfig","CSS","DOM","Emote","Env","MercuryMessageRenderer","MercuryAttachment","MercuryAttachmentRenderer","MercuryMessages","MercuryThreadMetadataRenderer","MercuryThreads","MercuryParticipants","MercuryThreadInformer","Tooltip","VideoCallCore","copyProperties","isRTL","tx","date-extensions","MercuryRoger","ChatTabTemplates","MercuryAttachmentTemplates","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('Bootloader'),j=b('ChannelConstants'),k=b('ChatVisibility'),l=b('ChatConfig'),m=b('CSS'),n=b('DOM'),o=b('Emote'),p=b('Env'),q=b('MercuryMessageRenderer'),r=b('MercuryAttachment'),s=b('MercuryAttachmentRenderer'),t=b('MercuryMessages'),u=b('MercuryThreadMetadataRenderer'),v=b('MercuryThreads'),w=b('MercuryParticipants'),x=b('MercuryThreadInformer'),y=b('Tooltip'),z=b('VideoCallCore'),aa=c('ChatTabTemplates'),ba=c('MercuryAttachmentTemplates'),ca=c('MercuryConstants'),da=b('copyProperties'),ea=b('isRTL'),fa=b('tx');b('date-extensions');b('MercuryRoger');function ga(ra){return Date.format(l.get('24h_times')?'H:i':'g:ia',ra/1000);}function ha(ra){var sa=aa[':fb:chat:conversation:message-group'].build();sa.setNodeContent('timestamp',ga(ra.timestamp));w.get(ra.author,function(ta){var ua=sa.getNode('profileLink');ua.href=ta.href;var va=ta.fbid==p.user?"You":ta.name;y.set(ua,va,'left');sa.setNodeProperty('profilePhoto','src',ta.image_src);});return sa;}function ia(ra){var sa=aa[':fb:chat:conversation:message:event'].build();sa.setNodeContent('timestamp',ga(ra.timestamp));q.renderLogMessage(sa.getNode('icon'),sa.getNode('message'),ra);var ta=ja(ra);if(ta)n.appendContent(sa.getNode('message'),ta);return sa.getRoot();}function ja(ra){var sa,ta;if(ra.log_message_type==ca.MercuryLogMessageType.VIDEO_CALL)if(ra.log_message_data.event_name=='install_canceled'){sa=n.tx._("Retry setup and call back.");ta='callback_cancelinstall_link';return ka(sa,ra.thread_id,ra.log_message_data.to,ta);}else if(!ra.log_message_data.event_name&&ra.log_message_data.callee==w.user&&!ra.log_message_data.answered){sa=n.tx._("Call Back");ta='callback_link';return ka(sa,ra.thread_id,ra.log_message_data.caller.split(':')[1],ta);}return null;}function ka(ra,sa,ta,ua){if(z.isSupported()){var va=!k.isOnline()||!z.availableForCall(ta),wa=n.$N('a',{href:'#',className:'callBackLink'},ra);if(va)m.hide(wa);wa.setAttribute('data-gt',JSON.stringify({videochat:'clicked_callback_link'}));Event.listen(wa,'click',function(){pa.inform('video-call-clicked',{userID:ta,threadID:sa,clickSource:ua});});return wa;}return null;}function la(ra){var sa=aa[':fb:mercury:chat:message:forward'].build(),ta=sa.getNode('forwardText');if(ta){m.hide(sa.getRoot());u.renderTitanLink(ra.thread_id,sa.getNode('forwardLink'),m.show.bind(m,sa.getRoot()));if(ra.forward_count>1){n.appendContent(ta,fa._("{count} forwarded messages",{count:ra.forward_count}));}else n.appendContent(ta,"1 forwarded message");}return sa.getRoot();}var ma=["January","February","March","April","May","June","July","August","September","October","November","December"];function na(ra){var sa=new Date();sa.setHours(0);sa.setMinutes(0);sa.setSeconds(0);sa.setMilliseconds(0);var ta=24*60*60*1000,ua=sa.getTime()-ra.getTime();if(ua<=0){return "Today";}else if(ua<ta)return "Yesterday";return fa._("{month} {date}",{month:ma[ra.getMonth()],date:ra.getDate()});}var oa=[];function pa(ra,sa,ta,ua){this.threadID=ra;this.scrollContainer=sa;this.conversationElem=ta;this.messageGroup=null;this.prevMessage=null;var va=ca.MercuryThreadlistConstants.MESSAGE_TIMESTAMP_THRESHOLD;this._olderTimestamp=(new Date()).getTime()-va;oa.push(this);this._subscription=g.subscribe('overflow-applied-to-body',this.scrollToBottom.bind(this));if(ua)i.loadModules(['ChatTabIndicatorLine'],function(wa){if(!this.destroyed){this.indicatorLine=new wa(this.threadID,ua,this);this.indicatorLine.setLastMessage(this.prevMessage);this.scrollToBottom();}}.bind(this));t.getThreadMessagesRange(this.threadID,0,ca.MercuryThreadlistConstants.RECENT_MESSAGES_LIMIT,Function.prototype);this.rerender();}da(pa,h);da(pa.prototype,{destroy:function(){n.empty(this.conversationElem);this._subscription.unsubscribe();oa.remove(this);this.indicatorLine&&this.indicatorLine.destroy();this.destroyed=true;},_appendMessage:function(ra){if(ra==this.prevMessage)return;var sa=ca.MercuryThreadlistConstants,ta=sa.GROUPING_THRESHOLD,ua=ra.action_type==ca.MercuryActionType.LOG_MESSAGE&&ra.log_message_type==ca.MercuryLogMessageType.SERVER_ERROR;if(ra.status==ca.MercuryActionStatus.RESENT)return;if(ra.is_cleared)return;var va=null;if(this.prevMessage)va=new Date(this.prevMessage.timestamp);var wa=new Date(ra.timestamp);if(!ua&&(!va||va.getDate()!=wa.getDate()||va.getMonth()!=wa.getMonth()||va.getFullYear()!=wa.getFullYear())){var xa=aa[':fb:chat:conversation:date-break'].build();n.setContent(xa.getRoot(),na(wa));n.appendContent(this.conversationElem,xa.getRoot());this.messageGroup=null;}if(ra.action_type==ca.MercuryActionType.LOG_MESSAGE){n.appendContent(this.conversationElem,ia(ra));this.messageGroup=null;this.prevMessage=ra;return;}if(!this.messageGroup||this.prevMessage.author!=ra.author||this.prevMessage.timestamp<ra.timestamp-ta){this.messageGroup=ha(ra);n.appendContent(this.conversationElem,this.messageGroup.getRoot());}var ya=this._renderSingleMessage(ra);n.appendContent(this.messageGroup.getNode('messages'),ya);this.prevMessage=ra;},rerender:function(){n.empty(this.conversationElem);this.messageGroup=null;this.prevMessage=null;var ra=t.getThreadMessagesSinceTimestamp(this.threadID,this._olderTimestamp);this._appendMessages(ra);},_appendMessages:function(ra){ra.forEach(this._appendMessage.bind(this));this.indicatorLine&&this.indicatorLine.setLastMessage(this.prevMessage);this.scrollToBottom();},isScrolledToBottom:function(){var ra=this.scrollContainer;return ra.scrollTop+ra.clientHeight>=ra.scrollHeight;},scrollToBottom:function(){this.scrollContainer.scrollTop=this.scrollContainer.scrollHeight;},_renderSingleMessage:function(ra){var sa=aa[':fb:chat:conversation:message'].render();if(ra.subject){var ta=aa[':fb:chat:conversation:message:subject'].render();n.setContent(ta,ra.subject);n.appendContent(sa,ta);}if(ra.body.substr(0,4)=='?OTR'){n.setContent(sa,"[encrypted message]");m.addClass(sa,'cyphertext');}else{m.addClass(sa,ea(ra.body)?'direction_rtl':'direction_ltr');n.appendContent(sa,q.formatMessageBody(ra.body));}if(ra.has_attachment)this._appendMessageAttachments(sa,ra.attachments);if(ra.forward_count)n.appendContent(sa,la(ra));if(ra.status!==undefined&&ra.status!=ca.MercuryActionStatus.SUCCESS&&ra.status!=ca.MercuryActionStatus.UNCONFIRMED){var ua=u.renderStatusIndicator(ra.status,t.resendMessage.bind(t,ra));m.addClass(sa,'errorStatus');var va=aa[':fb:chat:conversation:message:status'].build();n.appendContent(va.getNode('message'),sa);n.appendContent(va.getNode('status'),ua);return va.getRoot();}return sa;},_appendMessageAttachments:function(ra,sa){var ta=ca.MercuryAttachmentType;for(var ua=0,va=sa.length;ua<va;++ua){var wa=sa[ua],xa=wa.attach_type,ya=wa.share_data_type;if(xa==ta.ERROR)n.appendContent(ra,s.renderError(wa));if(xa==ta.FILE)n.appendContent(ra,s.renderFileLink(wa));var za=null,ab;if(xa==ta.SHARE&&ya==ca.MercurySupportedShareType.FB_VIDEO){za=s.renderVideoThumb(wa);ab=n.find(za,'img');Event.listen(ab,'load',this._thumbLoaded.shield(this,ab));}else if(xa==ta.SHARE&&(ya==ca.MercurySupportedShareType.FB_MUSIC_ALBUM||ya==ca.MercurySupportedShareType.FB_SONG)){za=s.renderMusic(wa);ab=n.find(za,'img');Event.listen(ab,'load',this._thumbLoaded.shield(this,ab));}else if(xa==ta.SHARE&&(ya==ca.MercurySupportedShareType.EXTERNAL||ya==ca.MercurySupportedShareType.FB_TEMPLATE)){za=s.renderExternalLink(wa);ab=n.find(za,'img');Event.listen(ab,'load',this._thumbLoaded.shield(this,ab));}else if(wa.preview_url){za=s.renderPreview(wa);ab=n.find(za,'img');Event.listen(ab,'load',this._thumbLoaded.shield(this,ab));}else if(xa==ta.SHARE)za=s.renderShareLink(wa);if(za)n.appendContent(ra,za);}},_thumbLoaded:function(ra){var sa=this.scrollContainer.scrollTop+this.scrollContainer.clientHeight;if(sa+ra.offsetHeight>=this.scrollContainer.scrollHeight)this.scrollToBottom();}});x.subscribe(['messages-reordered','messages-updated'],function(ra,sa){oa.forEach(function(ta){sa[ta.threadID]&&ta.rerender();});});x.subscribe('messages-received',function(ra,sa){oa.forEach(function(ta){var ua=sa[ta.threadID];ua&&ta._appendMessages(ua);});});g.subscribe(j.getArbiterType('chat_event'),function(ra,sa){if(qa(sa.obj)){var ta=(p.user==sa.obj.from)?sa.obj.to:sa.obj.from,ua=v.getThreadIdForUser(ta),va=oa.filter(function(ya){return ya.threadID===ua;});if(va.length>0){var wa=va[0],xa=t.constructLogMessageObject(ca.MercurySourceType.CHAT_WEB,ua,ca.MercuryLogMessageType.VIDEO_CALL,sa.obj);xa.author='fbid:'+sa.obj.from;wa._appendMessages([xa]);}}});function qa(ra){return (ra.event_name==='installing'||ra.event_name==='install_canceled');}e.exports=pa;});
__d("ChatTabSheetPolicy",[],function(a,b,c,d,e,f){var g={canReplaceOpenSheet:function(h,i){if(h.getType()==i.getType())return false;if(h.isPermanent()&&!i.isPermanent())return false;return true;}};e.exports=g;});
__d("ChatTabSheetView",["event-extensions","Animation","ChatTabSheetPolicy","CSS","DOM","Style","Vector","copyProperties","ChatTabTemplates"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Animation'),h=b('ChatTabSheetPolicy'),i=b('CSS'),j=b('DOM'),k=b('Style'),l=b('Vector'),m=b('copyProperties'),n=c('ChatTabTemplates'),o=5000,p=function(q,r,s){this._threadID=q;this._rootElement=r;this._tabMainElement=s;this._openSheet=null;};m(p.prototype,{destroy:function(){j.empty(this._rootElement);},_openCommon:function(q,r){if(this._openSheet&&!h.canReplaceOpenSheet(this._openSheet,q))return;this.clear(function(){this._openSheet=q;var s=n[':fb:mercury:chat:tab-sheet:loading'].build().getRoot();j.setContent(this._rootElement,s);i.show(s);i.show(this._rootElement);q.render();if(r){i.addClass(this._tabMainElement,'sheetSlide');var t=l.getElementDimensions(this._rootElement).y;k.set(this._rootElement,'bottom',t+'px');this._animation=new g(this._rootElement).to('bottom',0).duration(150).ease(g.ease.both).ondone(function(){i.removeClass(this._tabMainElement,'sheetSlide');}.bind(this)).go();}if(!q.isPermanent()){var u=o;if(q.getCloseTimeout)u=q.getCloseTimeout();this._sheetCloseHandler=this.close.bind(this,q).defer(u,false);}}.bind(this));},set:function(q){return this._openCommon(q,false);},open:function(q){return this._openCommon(q,true);},close:function(q,r){if(this._openSheet!=q)return;if(!this._openSheet){r&&r();return;}if(this._animation)this._animation.stop();if(this._sheetCloseHandler){clearTimeout(this._sheetCloseHandler);this._sheetCloseHandler=null;}i.addClass(this._tabMainElement,'sheetSlide');var s=l.getElementDimensions(this._rootElement).y;this._animation=new g(this._rootElement).to('bottom',s+'px').duration(100).ease(g.ease.begin).ondone(function(){j.empty(this._rootElement);i.hide(this._rootElement);i.removeClass(this._tabMainElement,'sheetSlide');this._openSheet=null;r&&r();}.bind(this)).go();},clear:function(q){this.close(this._openSheet,q);}});e.exports=p;});
__d("MercuryTypeahead",["ArbiterMixin","copyProperties","DOM","Env","Input","Tokenizer","Typeahead","TypeaheadCore","MercuryTypeaheadTemplates"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('copyProperties'),i=b('DOM'),j=b('Env'),k=b('Input'),l=b('Tokenizer'),m=b('Typeahead'),n=b('TypeaheadCore'),o=c('MercuryTypeaheadTemplates'),p=function(q,r){this._domElement=null;this._typeahead=null;this._tokenizer=null;this._placeholder='';this._exclusions=[];this._viewNodeID=null;this._viewOptions={renderer:'compact',autoSelect:true};this._tokenizerBehaviors={};this._dataSource=q;this._view=r;};h(p.prototype,g);h(p.prototype,{setPlaceholder:function(q){this._placeholder=q;return this;},setExcludedParticipants:function(q){this._exclusions=[];q.forEach(function(r){var s=r.indexOf(':');if(r.substr(0,s)=='fbid')this._exclusions.push(r.substr(s+1));}.bind(this));return this;},setViewNodeID:function(q){this._viewNodeID=q;},setViewOption:function(q,r){this._viewOptions[q]=r;},addTokenizerBehavior:function(q){this._tokenizerBehaviors[q]=true;},build:function(q){if(this._domElement)return;var r=o[':fb:mercury:tokenizer'].build(),s=o[':fb:mercury:typeahead'].build();this._domElement=r.getRoot();i.appendContent(this._domElement,s.getRoot());var t=s.getNode('textfield');k.setPlaceholder(t,this._placeholder);t.setAttribute('data-placeholder',this._placeholder);var u={node_id:this._viewNodeID,ctor:this._view,options:this._viewOptions},v={ctor:n,options:{setValueOnSelect:true}};this._typeahead=new m(this._dataSource,u,v,s.getRoot());this._typeahead.init();var w={inline:true,behaviors:this._tokenizerBehaviors};this._tokenizer=new l(this._domElement,this._typeahead);this._tokenizer.init(r.getNode('tokenarea'),'participants',[],w);this._tokenizer.subscribe(['addToken','removeToken','removeAllTokens'],function(){this.inform('tokens-changed');}.bind(this));Event.listen(t,'focus',function(){this._resetDataSource();this._typeahead.init();}.bind(this));Event.listen(this._domElement,'click',this.focus.bind(this));},getElement:function(){return this._domElement;},getSelectedParticipantIDs:function(){var q=[];if(this._tokenizer)(this._tokenizer.getTokenValues()||[]).forEach(function(r){q.push('fbid:'+r);});return q;},getTokens:function(){var q=[];if(this._tokenizer)q=this._tokenizer.getTokens();return q;},getTokenizer:function(){return this._tokenizer;},reset:function(){this._tokenizer&&this._tokenizer.removeAllTokens();this._typeahead&&this._typeahead.getCore().reset();},focus:function(){this._tokenizer&&this._tokenizer.focusInput();},getTypeahead:function(){return this._typeahead;},_resetDataSource:function(){this._dataSource.setExclusions(this._exclusions);}});e.exports=p;});
__d("ChatAddFriendsTabSheet",["Arbiter","ChatTabSheetView","ContextualTypeaheadView","copyProperties","DOM","MercuryTypeahead","MercuryMessages","MultiChatController","MercuryServerRequests","MercuryThreads","tx","MercuryConstants","MercuryDataSource","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChatTabSheetView'),i=b('ContextualTypeaheadView'),j=b('copyProperties'),k=b('DOM'),l=b('MercuryTypeahead'),m=b('MercuryMessages'),n=b('MultiChatController'),o=b('MercuryServerRequests'),p=b('MercuryThreads'),q=c('MercuryConstants'),r=c('MercuryDataSource'),s=c('ChatTabTemplates'),t=b('tx');function u(x,y,z){this._threadID=x;this._rootElement=y;this._sheetView=z;}j(u.prototype,{render:function(){var x=s[':fb:mercury:chat:tab-sheet:add-friends'].build();p.getThreadMeta(this._threadID,function(y){var z=new l(r,i);z.setExcludedParticipants(y.participants);z.setPlaceholder("Enter a friend's name");z.build();k.replace(x.getNode('participantsTypeahead'),z.getElement());k.setContent(this._rootElement,x.getRoot());z.focus();var aa=y.participants,ba=y.is_canonical_user?v.bind(null,this,this._sheetView,aa,z):w.bind(null,this,this._sheetView,this._threadID,z);Event.listen(x.getNode('doneButton'),'click',ba);}.bind(this));},isPermanent:function(){return true;},getType:function(){return 'add_friends_type';},open:function(){this._sheetView.open(this);}});function v(x,y,z,aa){var ba=aa.getSelectedParticipantIDs();if(ba.length)n.createThreadForTokens(z.concat(ba));y.close(x);}function w(x,y,z,aa){var ba=aa.getSelectedParticipantIDs();if(ba.length)if(p.isEmptyLocalThread(z)){p.addParticipantsToThreadLocally(z,ba);}else m.sendMessage(m.constructLogMessageObject(q.MercurySourceType.CHAT_WEB,z,q.MercuryLogMessageType.SUBSCRIBE,{added_participants:ba}));y.close(x);}e.exports=u;});
__d("ChatAvailabilityTabSheet",["Arbiter","AvailableList","AvailableListConstants","ChatConfig","CSS","DOM","GenderConst","MercuryThreads","ShortProfiles","copyProperties","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AvailableList'),i=b('AvailableListConstants'),j=b('ChatConfig'),k=b('CSS'),l=b('DOM'),m=b('GenderConst'),n=b('MercuryThreads'),o=b('ShortProfiles'),p=b('copyProperties'),q=c('ChatTabTemplates');function r(v,w,x,y){this._handledAvailability=w;this._sheetView=y;this._rootElement=x;this._canonicalUser=n.getCanonicalUserInThread(v);if(this._canonicalUser){this._currentAvailability=i.ACTIVE;this._handleAvailabilityChange();g.subscribe(i.ON_AVAILABILITY_CHANGED,this._handleAvailabilityChange.bind(this));}}r.createSheets=function(v,w,x){var y={};if(j.get('roger.ui')){y[i.OFFLINE]=new r(v,i.OFFLINE,w,x);return y;}[i.ACTIVE,i.OFFLINE,i.MOBILE].forEach(function(z){y[z]=new r(v,z,w,x);});return y;};p(r.prototype,{render:function(){!this._canonicalUser;var v=q[':fb:mercury:chat:tab-sheet:message-icon-sheet'].build();o.get(this._canonicalUser,function(w){var x=null;switch(this._currentAvailability){case i.ACTIVE:k.addClass(v.getRoot(),'active');x=s(w);break;case i.MOBILE:k.addClass(v.getRoot(),'mobile');x=t(w);break;case i.OFFLINE:x=u(w);break;}l.setContent(v.getNode('text'),x);l.setContent(this._rootElement,v.getRoot());}.bind(this));},isPermanent:function(){return false;},getType:function(){switch(this._handledAvailability){case i.ACTIVE:return 'availability_active_type';case i.MOBILE:return 'availability_mobile_type';case i.OFFLINE:return 'availability_offline_type';default:throw new Error("Invalid handled availability");}},getCloseTimeout:function(){return 5000;},_handleAvailabilityChange:function(){var v=h.get(this._canonicalUser);if(v==this._currentAvailability)return;this._currentAvailability=v;if(v==this._handledAvailability)this._sheetView.open(this);}});function s(v){return l.tx._("{name} is now available.",{name:v.firstName});}function t(v){return l.tx._("Your messages will be sent to {name}'s phone.",{name:v.firstName});}function u(v){switch(v.gender){case m.FEMALE_SINGULAR:case m.FEMALE_SINGULAR_GUESS:return l.tx._("{name} is offline, but you can still send her a message.",{name:v.firstName});case m.MALE_SINGULAR:case m.MALE_SINGULAR_GUESS:return l.tx._("{name} is offline, but you can still send him a message.",{name:v.firstName});default:return l.tx._("{name} is offline, but you can still send them a message.",{name:v.firstName});}}e.exports=r;});
__d("ChatNoListenersTabSheet",["Arbiter","copyProperties","DOM","MusicConstants","MercuryAssert","MercuryIDs","MercuryParticipants","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('DOM'),j=b('MusicConstants'),k=b('MercuryAssert'),l=b('MercuryIDs'),m=b('MercuryParticipants'),n=c('ChatTabTemplates');function o(p,q,r){k.isThreadID(p);var s=l.tokenize(p);if(s.type!='live_listen')throw 'bad live_listen thread id';this._sessionID=s.value;this._rootElement=q;this._sheetView=r;a.MusicEvents.subscribe([j.LIVE_LISTEN_OP.END_SESSION],this._handleEndSession.bind(this),g.SUBSCRIBE_NEW);}h(o.prototype,{render:function(){var p=n[':fb:mercury:chat:tab-sheet:message-icon-sheet'].build();i.setContent(p.getNode('text'),i.tx._("There is no longer anyone listening with you."));i.setContent(this._rootElement,p.getRoot());},isPermanent:function(){return true;},getType:function(){return 'no_listeners_type';},_handleEndSession:function(p,q){if(q&&q.session&&q.session.session_id==this._sessionID)this._sheetView.open(this);}});e.exports=o;});
__d("ChatNoRecipientsTabSheet",["DOM","MercuryParticipants","MercuryThreadInformer","MercuryThreads","copyProperties","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('DOM'),h=b('MercuryParticipants'),i=b('MercuryThreadInformer'),j=b('MercuryThreads'),k=b('copyProperties'),l=c('ChatTabTemplates');function m(n,o,p){this._threadID=n;this._rootElement=o;this._sheetView=p;i.subscribe('threads-updated',this._handleThreadsUpdated.bind(this));}k(m.prototype,{render:function(){var n=l[':fb:mercury:chat:tab-sheet:message-icon-sheet'].build();g.setContent(n.getNode('text'),g.tx._("All recipients have left this conversation. Please close the stale tab."));g.setContent(this._rootElement,n.getRoot());},isPermanent:function(){return true;},getType:function(){return 'no_recipients_type';},_handleThreadsUpdated:function(){j.getThreadMeta(this._threadID,function(n){var o=h.user,p=n.participants.filter(function(q){return q!=o;});if(p.length<1){this._sheetView.open(this);}else this._sheetView.close(this);}.bind(this));}});e.exports=m;});
__d("ChatOfflineTabSheet",["ChatPrivacyActionController","ChatTabSheetView","ChatVisibility","copyProperties","CSS","DOM","JSLogger","MercuryThreads","MercuryParticipants","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('ChatPrivacyActionController'),h=b('ChatTabSheetView'),i=b('ChatVisibility'),j=b('copyProperties'),k=b('CSS'),l=b('DOM'),m=b('JSLogger'),n=b('MercuryThreads'),o=b('MercuryParticipants'),j=b('copyProperties'),p=c('ChatTabTemplates');function q(r,s,t){this._rootElement=s;this._sheetView=t;this._logger=m.create('blackbird');this._canonicalUser=n.getCanonicalUserInThread(r);if(this._canonicalUser)this._privacyActionController=new g(this._canonicalUser,this._handlePrivacyChange.bind(this));}j(q.prototype,{render:function(){if(!this._canonicalUser)this._logger.error('offline_sheet_open_with_non_friend');var r=p[':fb:mercury:chat:tab-sheet:message-icon-sheet'].build(),s='fbid:'+this._canonicalUser;o.get(s,function(t){var u='fbChatGoOnlineLink',v=l.$N('a',{href:'#',className:u},l.tx._("go online")),w=l.tx._("You are now offline. To chat with {name} and other friends, {link}.",{name:t.short_name,link:v});l.setContent(r.getNode('text'),w);k.addClass(r.getRoot(),'chatOffline');l.setContent(this._rootElement,r.getRoot());Event.listen(this._rootElement,'click',function(event){if(k.hasClass(event.getTarget(),u)){if(i.isOnline())this._logger.error('tab_sheet_already_online');this._privacyActionController.togglePrivacy();this._logger.log('tab_sheet_go_online',{tab_id:this._canonicalUser});return false;}}.bind(this));}.bind(this));},_handlePrivacyChange:function(r){if(!this._canonicalUser)this._logger.error('user_blocked_sheet_privacy_changed_non_friend');switch(r){case g.OFFLINE:this._sheetView.open(this);break;case g.NORMAL:case g.BLOCKED:this._sheetView.close(this);break;}},isPermanent:function(){return true;},getType:function(){return 'offline_type';}});e.exports=q;});
__d("ChatUserBlockedTabSheet",["ChatPrivacyActionController","ChatTabSheetView","copyProperties","CSS","DOM","GenderConst","JSLogger","MercuryThreads","MercuryParticipants","tx","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('ChatPrivacyActionController'),h=b('ChatTabSheetView'),i=b('copyProperties'),j=b('CSS'),k=b('DOM'),l=b('GenderConst'),m=b('JSLogger'),n=b('MercuryThreads'),o=b('MercuryParticipants'),p=c('ChatTabTemplates'),q=b('tx');function r(s,t,u){this._rootElement=t;this._sheetView=u;this._logger=m.create('blackbird');this._canonicalUser=n.getCanonicalUserInThread(s);if(this._canonicalUser)this._privacyActionController=new g(this._canonicalUser,this._handlePrivacyChange.bind(this));}i(r.prototype,{render:function(){if(!this._canonicalUser)this._logger.error('user_blocked_sheet_open_with_non_friend');var s=p[':fb:mercury:chat:tab-sheet:user-blocked'].build(),t='fbid:'+this._canonicalUser;o.get(t,function(u){var v=null;switch(u.gender){case l.FEMALE_SINGULAR:case l.FEMALE_SINGULAR_GUESS:v=q._("{name} sees you as offline on chat, but you can still send her a message. ",{name:u.short_name});break;case l.MALE_SINGULAR:case l.MALE_SINGULAR_GUESS:v=q._("{name} sees you as offline on chat, but you can still send him a message. ",{name:u.short_name});break;default:v=q._("{name} sees you as offline on chat, but you can still send them a message. ",{name:u.short_name});}k.setContent(s.getNode('text'),v);var w=q._("Go Online to {name}",{name:u.short_name});k.setContent(s.getNode('actionLink'),w);j.addClass(s.getRoot(),'blocked');k.setContent(this._rootElement,s.getRoot());Event.listen(s.getNode('actionLink'),'click',this._privacyActionController.togglePrivacy.bind(this._privacyActionController));}.bind(this));},_handlePrivacyChange:function(s){if(!this._canonicalUser)this._logger.error('user_blocked_sheet_privacy_changed_non_friend');switch(s){case g.BLOCKED:this._sheetView.open(this);break;case g.NORMAL:case g.OFFLINE:this._sheetView.close(this);break;}},isPermanent:function(){return true;},getType:function(){return 'user_blocked_type';}});e.exports=r;});
__d("ChatTabSheetController",["ChatAddFriendsTabSheet","ChatAvailabilityTabSheet","ChatNoListenersTabSheet","ChatNoRecipientsTabSheet","ChatOfflineTabSheet","ChatTabSheetView","ChatUserBlockedTabSheet","copyProperties","MercuryServerRequests","MercuryThreads"],function(a,b,c,d,e,f){var g=b('ChatAddFriendsTabSheet'),h=b('ChatAvailabilityTabSheet'),i=b('ChatNoListenersTabSheet'),j=b('ChatNoRecipientsTabSheet'),k=b('ChatOfflineTabSheet'),l=b('ChatTabSheetView'),m=b('ChatUserBlockedTabSheet'),n=b('copyProperties'),o=b('MercuryServerRequests'),p=b('MercuryThreads'),q=function(r,s,t){this._sheetView=new l(r,s,t);this._addFriendsTabSheet=new g(r,s,this._sheetView);this._userBlockedTabSheet=new m(r,s,this._sheetView);this._offlineTabSheet=new k(r,s,this._sheetView);this._availabilityTabSheets=h.createSheets(r,s,this._sheetView);if(p.isMultichatThread(r)){this._noRecipientsTabSheet=new j(r,s,this._sheetView);}else if(p.isLiveListenThread(r))this._noListenersTabSheet=new i(r,s,this._sheetView);};n(q.prototype,{openAddFriendsSheet:function(){this._addFriendsTabSheet.open();},destroy:function(){this._sheetView.destroy();}});e.exports=q;});
__d("MercuryTypingReceiver",["Arbiter","ChannelConstants","MercuryParticipants","MercuryServerRequests","MercuryThreads","TypingDetector","setTimeoutAcrossTransitions","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChannelConstants'),i=b('MercuryParticipants'),j=b('MercuryServerRequests'),k=b('MercuryThreads'),l=b('TypingDetector'),m=b('setTimeoutAcrossTransitions'),n=c('MercuryConstants'),o,p={},q=30000,r=new g();function s(){return new Date().getTime();}function t(){o=null;var w=s(),x={};for(var y in p)if(p[y]<w-q){delete p[y];x[y]=false;}for(var z in x){r.inform('state-changed',x);break;}for(z in p){o=m(t,3000);return;}}function u(w){if(w in p){delete p[w];v(w);}}function v(w){var x={};x[w]=w in p;r.inform('state-changed',x);}g.subscribe(h.getArbiterType('typ'),function(w,x){var y=x.obj,z='user:'+y.from;if(y.st==l.TYPING){var aa=z in p;p[z]=s();if(!o)o=m(t,3000);!aa&&v(z);}else if(y.st==l.INACTIVE)u(z);});j.subscribe('update-typing-state',function(w,x){var y=x.payload_source;if(y!=n.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE)return;var z=x.actions;if(!z||!z.length)return;var aa=n.MercuryActionType.USER_GENERATED_MESSAGE;z.forEach(function(ba){var ca=ba.thread_id;if(ba.action_type==aa&&k.getCanonicalUserInThread(ca)&&ba.author!=i.user)u(ca);});});e.exports=r;});
__d("ChatTabView",["event-extensions","function-extensions","Arbiter","ArbiterMixin","AvailableList","AvailableListConstants","ChatConfig","ChatContextualDialogController","ChatQuietLinks","ChatPrivacyActionController","ChatTabEmoticonView","ChatTabMessagesView","ChatTabSheetController","ChatVisibility","CSS","Dialog","Dock","DOM","JSLogger","Keys","MercuryMessages","MercuryParticipants","MercuryServerRequests","MercuryThreadInformer","MercuryThreadMetadataRenderer","MercuryThreads","MercuryTypingReceiver","NubController","Parent","PresencePrivacy","Style","TextAreaControl","Tooltip","TypingIndicator","URI","UserAgent","VideoCallCore","copyProperties","setIntervalAcrossTransitions","tx","MercuryConstants","ChatTabTemplates"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('AvailableList'),j=b('AvailableListConstants'),k=b('ChatConfig'),l=b('ChatContextualDialogController'),m=b('ChatQuietLinks'),n=b('ChatPrivacyActionController'),o=b('ChatTabEmoticonView'),p=b('ChatTabMessagesView'),q=b('ChatTabSheetController'),r=b('ChatVisibility'),s=b('CSS'),t=b('Dialog'),u=b('Dock'),v=b('DOM'),w=b('JSLogger'),x=b('Keys'),y=b('MercuryMessages'),z=b('MercuryParticipants'),aa=b('MercuryServerRequests'),ba=b('MercuryThreadInformer'),ca=b('MercuryThreadMetadataRenderer'),da=b('MercuryThreads'),ea=b('MercuryTypingReceiver'),fa=b('NubController'),ga=b('Parent'),ha=b('PresencePrivacy'),ia=b('Style'),ja=b('TextAreaControl'),ka=b('Tooltip'),la=b('TypingIndicator'),ma=b('URI'),na=b('UserAgent'),oa=b('VideoCallCore'),pa=c('MercuryConstants'),qa=c('ChatTabTemplates'),ra=b('copyProperties'),sa=b('setIntervalAcrossTransitions'),ta=b('tx'),ua=w.create('tab_view'),va={};function wa(fb,gb){var hb=v.$N('div');gb=gb.filter(function(ib){return ib!=z.user;});z.getMulti(gb,function(ib){for(var jb in ib){var kb=ib[jb],lb=qa[':fb:mercury:chat:multichat-tooltip-item'].build();v.setContent(lb.getNode('name'),kb.name);var mb=z.getUserID(jb),nb=mb&&i.get(mb)==j.ACTIVE;s.conditionShow(lb.getNode('icon'),nb);s.conditionClass(lb.getNode('name'),'tooltipItemWithIcon',nb);v.appendContent(hb,lb.getRoot());}ka.set(fb,hb,'above','center');});}var xa={},ya=null,za=false;function ab(fb,gb,hb){if(hb){xa[fb]=gb;if(!ya)ya=sa(bb,600);}else{s.removeClass(gb,'highlightTitle');delete xa[fb];}}function bb(){for(var fb in xa){var gb=xa[fb];if(gb.parentNode){s.conditionClass(gb,'highlightTitle',za);}else delete xa[fb];}za=!za;if(!Object.keys(xa).length){clearInterval(ya);ya=null;}}function cb(fb){var gb=aa.tokenizeThreadID(fb);switch(gb.type){case 'user':return qa[':fb:mercury:chat:user-tab'].build();case 'group':return qa[':fb:mercury:chat:group-tab'].build();case 'live_listen':return qa[':fb:mercury:chat:live-listen-tab'].build();}return qa[':fb:mercury:chat:multichat-tab'].build();}function db(fb,gb){if(gb)aa.ensureThreadIsFetched(gb);this._threadID=fb;this._eventListeners=[];this._tabTemplate=cb(fb);this._tabElem=this._tabTemplate.getRoot();if(!(this._getNode instanceof Function))ua.log('getnode_undefined',{is_getnode_set:!!this._getNode,is_prototype_set:!!db.prototype,is_window:window==this,is_chat_tab_view:this instanceof db,ctor_name:this.constructor&&this.constructor.name});this._sheetController=new q(this._threadID,this._getNode('sheet'),this._tabElem);this._contextualDialogController=new l(this._threadID,this._getNode('videoCallLink'));this._messagesView=null;var hb=this._getNode('conversationLink');if(hb){s.hide(hb);ca.renderTitanLink(fb,hb,s.show.bind(s,hb));}if(da.isMultichatThread(this._threadID))this._titlebarTooltipAnchor=this._getNode('titlebarText');var ib=this._getCanonicalUserID();if(this._isTitleTextLinked())z.get('fbid:'+ib,function(nb){var ob=this._getNode('titlebarText');ob.setAttribute('href',nb.href);ob.removeAttribute('rel');s.removeClass(ob,'noLink');}.bind(this));this._nubController=new fa().init(this._tabElem);ja.getInstance(this._getNode('input')).subscribe('resize',function(){this._nubController.flyoutContentChanged();}.bind(this));this._listen('closeButton','click',this._closeClicked);this._listen('titlebarCloseButton','click',this._closeClicked);this._listen('dockButton','click',this._nubClicked);this._listen('dockButton','keydown',this._dockKeyDown);this._listen('nubFlyoutTitlebar','click',this._titleClicked);this._listen('chatConv','click',this._chatConvClicked);this._listen('addFriendLink','click',this._addFriendLinkClicked,true);this._listen('addToThreadLink','click',this._addFriendLinkClicked,true);this._listen('clearWindowLink','click',this._clearHistory,true);this._listen('unsubscribeLink','click',this._unsubscribeLinkClicked,true);this._listen('videoCallLink','click',this._callClicked,true);this._listen('reportSpamLink','click',this._reportSpamClicked,true);this._listen('input','focus',this._focusTab);this._listen('input','blur',this._blurTab);var jb=this._getNode('emoticons');if(jb)this._emoticonView=new o(jb,this._getNode('input'));if(na.firefox()){this._listen('input','keypress',this._inputKeyDown);}else this._listen('input','keydown',this._inputKeyDown);this._privacyLink=this._getNode('privacyLink');if(this._privacyLink){var kb=new n(ib,this._updatePrivacyLink.bind(this));this._eventListeners.push(Event.listen(this._privacyLink,'click',kb.togglePrivacy.bind(kb)));}if(ib){this._typingIndicator=new la(ib,this._getNode('input'),'mercury-chat');if(!k.get('roger.ui'))z.get('fbid:'+ib,function(nb){var ob=this._getNode('typingIndicator'),pb=ta._("{name} is typing...",{name:nb.short_name});v.setContent(ob,pb);}.bind(this));}if(k.get('roger.ui'))s.addClass(this._tabElem,'roger');var lb=this._getNode('muteGroupLink');if(lb){var mb=da.getCanonicalGroupInThread(this._threadID);if(mb)lb.setAttribute('ajaxify',ma(lb.getAttribute('ajaxify')).addQueryData({id:mb}));}m.removeLinkHrefs(this._tabElem);va[fb]=this;this.updateAvailableStatus();this.updateTab();}function eb(){for(var fb in va){va[fb].updateAvailableStatus();va[fb].updateMultichatTooltip();}}g.subscribe(['buddylist/availability-changed'],eb);ha.subscribe(['privacy-changed','privacy-availability-changed'],eb);ea.subscribe('state-changed',function(fb,gb){for(var hb in gb){var ib=va[hb];ib&&ib.showTypingIndicator(gb[hb]);}});ba.subscribe('threads-updated',function(fb,gb){for(var hb in va)gb[hb]&&va[hb].updateTab();});ba.subscribe('threads-deleted',function(fb,gb){for(var hb in va)db.inform('thread-deleted',hb);});ra(db,h,{get:function(fb){return va[fb];}});ra(db.prototype,{getThreadID:function(){return this._threadID;},isVisible:function(){return s.shown(this._tabElem);},setVisibleState:function(fb,gb){var hb=s.shown(this._tabElem),ib=s.hasClass(this._tabElem,'opened');s.conditionShow(this._tabElem,fb);s.conditionClass(this._tabElem,'opened',gb);if(!(hb&&ib)&&fb&&gb){if(!this._messagesView)this._messagesView=new p(this._threadID,this._getNode('chatConv'),this._getNode('conversation'),k.get('roger.ui')?this._getNode('typingIndicator'):null);this._nubController.flyoutContentChanged();this._messagesView.scrollToBottom();}if(hb&&ib&&!(fb&&gb))this._contextualDialogController.tabNotActive();},focus:function(){var fb=s.hasClass(this._tabElem,'opened')?'input':'dockButton';this._getNode(fb).focus();},isFocused:function(){var fb=document.activeElement;return ga.byClass(fb,'fbMercuryChatTab')===this._tabElem;},setInput:function(fb){this._getNode('input').value=fb;},insertBefore:function(fb){v.insertBefore(fb._tabElem,this._tabElem);},appendTo:function(fb){v.appendContent(fb,this._tabElem);},nextTabIs:function(fb){var gb=fb&&fb._tabElem;return this._tabElem.nextSibling==gb;},destroy:function(){v.remove(this._tabElem);this._emoticonView&&this._emoticonView.destroy();while(this._eventListeners.length)this._eventListeners.pop().remove();this._messagesView&&this._messagesView.destroy();this._sheetController.destroy();this._contextualDialogController.destroy();delete va[this._threadID];u.unregisterNubController(this._nubController);},updateAvailableStatus:function(){var fb={active:false,mobile:false,greenring:false},gb=this._getCanonicalUserID(),hb=true,ib=false;if(gb){var jb=i.get(gb);hb=!r.isOnline();ib=!ha.allows(gb);var kb=k.get('chat_mobile_icon_experiment_condition')||'normal';switch(kb){case 'mobile_green_circle':fb.active=(jb===j.ACTIVE)||(jb===j.MOBILE);break;case 'mobile_green_ring':fb.active=(jb===j.ACTIVE);fb.greenring=(jb===j.MOBILE);break;case 'all_green_ring':fb.greenring=(jb===j.ACTIVE)||(jb===j.MOBILE);break;default:fb.active=(jb===j.ACTIVE);fb.mobile=(jb===j.MOBILE);break;}this._updateCallLink(jb);}s.conditionClass(this._tabElem,'chatOffline',hb);s.conditionClass(this._tabElem,'blocked',!hb&&ib);for(var lb in fb)s.conditionClass(this._tabElem,lb,!hb&&!ib&&fb[lb]);},updateTab:function(){da.getThreadMeta(this._threadID,function(fb){if(!fb.is_subscribed){db.inform('unsubscribed',this._threadID);return;}ca.renderAndSeparatedParticipantList(this._threadID,[this._getNode('name'),this._getNode('titlebarText')],true,true);this._updateUnreadCount(fb);this.updateMultichatTooltip();this._updateArchiveWarning(fb);}.bind(this));},_updateArchiveWarning:function(fb){var gb=false;z.get(z.user,function(hb){gb=hb.employee;if(gb)z.getMulti(fb.participants,this._showArchiveWarningIfAllParticipantsAreEmployees.bind(this));}.bind(this));},_showArchiveWarningIfAllParticipantsAreEmployees:function(fb){var gb=true;for(var hb in fb)gb=gb&&fb[hb].employee;var ib=this._getNode('titanArchiveWarning');if(ib){if(this._titlebarTooltipAnchor)s.conditionClass(this._titlebarTooltipAnchor,'narrowTitleBar',gb);s.conditionShow(ib,gb);}},updateMultichatTooltip:function(){if(da.isMultichatThread(this._threadID))da.getThreadMeta(this._threadID,function(fb){wa(this._titlebarTooltipAnchor,fb.participants);}.bind(this));},_getNode:function(fb){return this._tabTemplate.getNode(fb);},_getCanonicalUserID:function(){return da.getCanonicalUserInThread(this._threadID);},_listen:function(fb,event,gb,hb){var ib=this._getNode(fb);if(ib){this._eventListeners.push(Event.listen(ib,event,gb.bind(this)));}else if(!hb)throw new Error('Could not find node "'+fb+'"');},_closeClicked:function(fb){db.inform('closed-tab',this._threadID);fb.prevent();},_nubClicked:function(){return db.inform('nub-activated',this._threadID);},_dockKeyDown:function(event){if(event.keyCode===x.RETURN||event.keyCode===x.SPACE){db.inform('nub-activated',this._threadID);event.kill();}else this._handleHotkeyPressed(event);},_handleHotkeyPressed:function(event){if(event.keyCode===x.ESC){db.inform('esc-pressed',this._threadID);event.kill();}else if(event.keyCode===x.TAB){var fb=db.inform('tab-pressed',{id:this._threadID,shiftPressed:event.shiftKey});!fb&&event.kill();}},_isTitleTextLinked:function(){var fb=this._getCanonicalUserID();return fb&&k.get('chat_tab_title_link_timeline');},_titleClicked:function(event){var fb=event.getTarget(),gb=ga.byClass(fb,'titlebarText'),hb=gb&&this._isTitleTextLinked();if(!hb&&!ga.byClass(fb,'uiSelector')&&!ga.byClass(fb,'addToThread'))db.inform('lower-activated',this._threadID);},_callClicked:function(fb){var gb=this._getCanonicalUserID();if(oa.availableForCall(gb)){var hb='chat_tab_icon';if(fb.target&&s.hasClass(fb.target,'video_call_promo')){hb='chat_tab_icon_promo';}else if(fb.target&&s.hasClass(fb.target,'video_call_tour'))hb='chat_tab_icon_tour';db.inform('video-call-clicked',{threadID:this._threadID,userID:gb,clickSource:hb});}return false;},_addFriendLinkClicked:function(){this._sheetController.openAddFriendsSheet();},_clearHistory:function(){var fb=da.getThreadMetaNow(this._threadID);if(fb){var gb=this._getCanonicalUserID();aa.clearChat(this._threadID,gb,fb.timestamp);}},_unsubscribeLinkClicked:function(){var fb=[];fb.push({name:'unsubscribe',label:"Leave Conversation",handler:this._unsubscribeToThread.bind(this)});fb.push(t.CANCEL);new t().setTitle("Leave Conversation?").setBody("You will stop receiving messages from this conversation and people will see that you left.").setButtons(fb).show();},_reportSpamClicked:function(){var fb=this._getCanonicalUserID(),gb=ma('/ajax/chat/report.php').addQueryData({id:fb}).addQueryData({src:'top_report_link'});t.bootstrap(gb.toString(),null,false);},_focusTab:function(){s.addClass(this._tabElem,'focusedTab');db.inform('focused',this._threadID);this._contextualDialogController.tabFocused();},_blurTab:function(){s.removeClass(this._tabElem,'focusedTab');},_inputKeyDown:function(event){if(event.keyCode===x.RETURN&&!event.shiftKey){var fb=this._getNode('input'),gb=fb.value||'';if(!/^\s*$/.test(gb))da.getThreadMeta(this._threadID,function(hb){var ib=y.constructUserGeneratedMessageObject(gb,pa.MercurySourceType.CHAT_WEB,this._threadID);if(da.isEmptyLocalThread(this._threadID)){var jb=aa.tokenizeThreadID(this._threadID);ib.message_id=jb.value;ib.specific_to_list=hb.participants;}y.sendMessage(ib);this._getNode('input').value='';this._typingIndicator&&this._typingIndicator.resetState();}.bind(this));event.kill();}if(event.keyCode===x.DOWN&&event.shiftKey&&this._getNode('input').value===''){db.inform('lower-activated',this._threadID);event.kill();return;}this._handleHotkeyPressed(event);},_chatConvClicked:function(){!v.getSelection()&&this.focus();},showTypingIndicator:function(fb){if(!k.get('roger.ui'))s.conditionClass(this._getNode('typingIndicator'),'typing',fb);s.conditionClass(this._tabElem,'typing',fb);},_updateUnreadCount:function(fb){var gb=fb.unread_count;if(typeof gb!='undefined'){var hb=this._getNode('numMessages');s.conditionShow(hb,gb);s.conditionClass(this._tabElem,'highlightTab',gb);if(k.get('chat_mark_read_on_focus'))ab(this._threadID,this._tabElem,!!gb);v.setContent(hb,gb);}},_updateCallLink:function(fb){var gb=this._getNode('videoCallLink');if(r.isOnline()){var hb=this._getCanonicalUserID(),ib='fbid:'+hb;z.get(ib,function(jb){if(oa.availableForCall(hb)){ka.set(gb,ta._("Start a video call with {firstname}",{firstname:jb.short_name}));this._updateCallBackLinks(this._tabElem,true);}else{ka.set(gb,ta._("{firstname} is currently unavailable for video calling",{firstname:jb.short_name}));this._hideVideoCallouts();this._updateCallBackLinks(this._tabElem,false);}}.bind(this));}else{ka.set(gb,"You must be online to make a call.");this._hideVideoCallouts();this._updateCallBackLinks(document.body,false);}},_updateCallBackLinks:function(fb,gb){var hb=v.scry(fb,'a.callBackLink');if(gb){hb.forEach(s.show);}else hb.forEach(s.hide);},_hideVideoCallouts:function(){this._contextualDialogController.hideVideoCallouts();},_updatePrivacyLink:function(fb){if(fb==n.OFFLINE){v.setContent(this._privacyLink,"Go online");}else{var gb=this._getCanonicalUserID(),hb='fbid:'+gb;z.get(hb,function(ib){var jb=null;if(fb==n.BLOCKED){jb=ta._("Go Online to {name}",{name:ib.short_name});}else jb=ta._("Go Offline to {name}",{name:ib.short_name});v.setContent(this._privacyLink,jb);}.bind(this));}},_unsubscribeToThread:function(){if(da.isEmptyLocalThread(this._threadID)){db.inform('unsubscribed',this._threadID);}else{var fb=y.constructLogMessageObject(pa.MercurySourceType.CHAT_WEB,this._threadID,pa.MercuryLogMessageType.UNSUBSCRIBE,{});y.sendMessage(fb);}return true;},_emoticonView:null});e.exports=db;});
__d("MercuryNotificationRenderer",["MercuryAssert","MercuryMessages","MercuryParticipants","MercuryThreads","tx"],function(a,b,c,d,e,f){var g=b('MercuryAssert'),h=b('MercuryMessages'),i=b('MercuryParticipants'),j=b('MercuryThreads'),k=b('tx');function l(m,n){g.isThreadID(m);j.getThreadMeta(m,function(o){h.getThreadMessagesRange(m,0,1,function(p){var q=p.length&&p[p.length-1];if(q&&q.author!=i.user){i.get(q.author,function(r){if(o.name&&!o.is_canonical_live_listen){n(k._("{senderName} messaged {groupName}",{senderName:r.short_name,groupName:o.name}));}else n(k._("{name} messaged you",{name:r.short_name}));});}else n("New message!");});});}e.exports={renderDocumentTitle:l};});
__d("ChatTitleBarBlinker",["ChatActivity","DocumentTitle","JSLogger","math-extensions","MercuryThreadInformer","MercuryNotificationRenderer","PresenceState","MercuryTimestampTracker","MercuryUnseenState","UserActivity"],function(a,b,c,d,e,f){var g=b('ChatActivity'),h=b('DocumentTitle'),i=b('JSLogger'),j=b('math-extensions'),k=b('MercuryThreadInformer'),l=b('MercuryNotificationRenderer'),m=b('PresenceState'),n=b('MercuryTimestampTracker'),o=b('MercuryUnseenState'),p=b('UserActivity'),q=i.create('chat_title'),r=null,s=0,t=false;function u(){if(r){r.stop();r=null;return true;}return false;}function v(aa){var ba=aa||n.getLastUserMessageTimestamp();if(s<=ba){s=ba;if(u()||t)m.doSync();}}var w={blink:function(aa,ba){if(!r&&s<ba)l.renderDocumentTitle(aa,function(ca){if(!r)r=h.blink(ca);});},stopBlinking:function(){v();},blinkingElsewhere:function(){t=true;}};function x(aa){var ba=j.verifyNumber(aa.sb2);if(!ba||ba<=s)return null;return ba;}function y(aa){var ba=aa&&x(aa);if(ba){s=ba;q.debug('load',s);u();t=false;}}function z(aa){var ba=x(aa);if(!ba){q.debug('store',s);aa.sb2=s;t=false;}return aa;}m.registerStateStorer(z);m.registerStateLoader(y);k.subscribe('thread-read-changed',function(aa,ba){var ca=n.getLastUserMessageTimestamp(),da=0;for(var ea in ba)if(ba[ea].mark_as_read&&ba[ea].timestamp>=ca&&ba[ea].timestamp>da)da=ba[ea].timestamp;da&&v(da);});g.subscribe('activity',function(){v();});(function(){var aa=m.getInitial();if(aa)s=x(aa)||0;})();e.exports=w;});
__d("ChatNewMessageHandler",["ChatActivity","ChatConfig","ChatBrowserNotificationHandler","ChatSound","ChatTabModel","ChatTabView","ChatTitleBarBlinker","JSLogger","MercuryAssert","MercuryThreads","MercuryUnseenState"],function(a,b,c,d,e,f){var g=b('ChatActivity'),h=b('ChatConfig'),i=b('ChatBrowserNotificationHandler'),j=b('ChatSound'),k=b('ChatTabModel'),l=b('ChatTabView'),m=b('ChatTitleBarBlinker'),n=b('JSLogger'),o=b('MercuryAssert'),p=b('MercuryThreads'),q=b('MercuryUnseenState'),r=n.create('chat_new_message');function s(u){p.changeThreadReadStatus(u,true);q.markThreadSeen(u);}var t={_raiseTab:function(u,v){var w=k.getTab(u),x=false;if(w){x=w.raised;}else{k.raiseTab(u,false);x=true;}v.to_new_tab=!w;v.to_raised_tab=!!x;},_notify:function(u,v,w){var x=l.get(u);w.view_is_visible=x&&x.isVisible();w.view_is_focused=x&&x.isFocused();if(!w.view_is_visible)r.log('message_to_hidden');var y=g.isActive();w.is_active=y;if(y){var z=false;if(x){z=k.getTab(u).raised;var aa=x.isVisible()&&z;if(aa&&h.get('chat_mark_read_on_focus'))aa=x.isFocused();if(aa)s(u);}if(!x||!z||!x.isFocused())j.messageReceived(v);}else{m.blink(u,v.timestamp);i.display(v);j.messageReceived(v);}m.blinkingElsewhere();},newMessage:function(u,v){o.isThreadID(u);var w={thread_id:u,message_id:v.message_id};this._raiseTab(u,w);this._notify(u,v,w);r.log('message',w);}};e.exports=t;});
__d("ChatTabPolicy",["ChatBehavior","FBDesktopPlugin","JSLogger","MercuryAssert","MercuryParticipants","MercuryThreads","MercuryUnseenState","PresencePrivacy","ShortProfiles","MercuryConstants"],function(a,b,c,d,e,f){var g=b('ChatBehavior'),h=b('FBDesktopPlugin'),i=b('JSLogger'),j=b('MercuryAssert'),k=b('MercuryParticipants'),l=b('MercuryThreads'),m=b('MercuryUnseenState'),n=b('PresencePrivacy'),o=b('ShortProfiles'),p=c('MercuryConstants'),q=i.create('tab_policy');function r(s,t){m.markThreadSeen(s,t);}e.exports={messageIsAllowed:function(s,t,u){var v=s.thread_id,w=t.message_id;j.isThreadID(v);j.isParticipantID(t.author);var x;if(s.mode==p.MercuryThreadMode.OBJECT_ORIGINATED){x={thread_id:v,message_id:w,mode:s.mode};q.log('message_object_originated',x);return;}var y=p.MercurySourceType;if(t.source==y.EMAIL||t.source==y.TITAN_EMAIL_REPLY){x={thread_id:v,message_id:w,source:t.source};q.log('message_source_not_allowed',x);return;}var z=k.getUserID(t.author);if(!z){q.log('message_bad_author',{thread_id:v,message_id:w,user:z});return;}if(t.action_type!=p.MercuryActionType.USER_GENERATED_MESSAGE){x={thread_id:v,message_id:w,type:t.action_type};q.log('message_non_user_generated',x);return;}if(s.is_canonical_user&&!g.notifiesUserMessages()){q.log('message_jabber',{thread_id:v,message_id:w});r(v,true);return;}if(s.is_canonical_user&&h.shouldSuppressUserMessages()){q.log('message_desktop',{thread_id:v,message_id:w});return;}if(!s.is_canonical_group&&!s.is_canonical_live_listen&&s.folder!=p.MessagingTag.INBOX){q.log('message_folder',{thread_id:v,message_id:w,folder:s.folder});return;}o.get(z,function(aa){if(!n.allows(z)){q.log('message_privacy',{thread_id:v,message_id:w,user:z});return;}if(!s.is_canonical_group&&!s.is_canonical_live_listen)if(aa.type!='friend'){q.log('message_non_friend',{thread_id:v,message_id:w,user:z});return;}u();});}};});
__d("ChatTabController",["ChatTabPresence","Arbiter","AsyncRequest","ChatActivity","ChatConfig","ChatNewMessageHandler","ChatSound","ChatTabMessagesView","ChatTabModel","ChatTabPolicy","ChatTabView","ChatTabViewSelector","ChatTitleBarBlinker","Dialog","JSLogger","MercuryMessages","MercuryParticipants","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","MercuryUnseenState","Style","UserAgent","VideoCallCore"],function(a,b,c,d,e,f){b('ChatTabPresence');var g=b('Arbiter'),h=b('AsyncRequest'),i=b('ChatActivity'),j=b('ChatConfig'),k=b('ChatNewMessageHandler'),l=b('ChatSound'),m=b('ChatTabMessagesView'),n=b('ChatTabModel'),o=b('ChatTabPolicy'),p=b('ChatTabView'),q=b('ChatTabViewSelector'),r=b('ChatTitleBarBlinker'),s=b('Dialog'),t=b('JSLogger'),u=b('MercuryMessages'),v=b('MercuryParticipants'),w=b('MercuryServerRequests'),x=b('MercuryThreadInformer'),y=b('MercuryThreads'),z=b('MercuryUnseenState'),aa=b('Style'),ba=b('UserAgent'),ca=b('VideoCallCore'),da=j.get('tab_auto_close_timeout')||7200000,ea=t.create('tab_controller');function fa(na){y.changeThreadReadStatus(na,true);ga(na);}function ga(na){z.markThreadSeen(na);}function ha(){var na=n.get();na.tabs.forEach(function(oa){var pa=p.get(oa.id);if(oa.raised&&pa&&pa.isVisible())fa(oa.id);});}function ia(){var na=n.get();na.tabs.forEach(function(oa){ga(oa.id);});}function ja(na,oa,pa){var qa=n.get().tabs;na+=oa?1:-1;while(na>=0&&na<qa.length){var ra=qa[na],sa=p.get(ra.id);if(sa&&sa.isVisible()&&(!pa||ra.raised)){sa.focus();return true;}na+=oa?1:-1;}return false;}function ka(na){function oa(ra){var sa=na.shouldPromoteOnRaise(ra);g.inform("chat/promote-tab",ra);if(sa){n.raiseAndPromoteTab(ra,true);}else n.raiseTab(ra,true);if(!j.get('chat_mark_read_on_focus'))fa(ra);var ta=p.get(ra);ta&&ta.focus();}function pa(ra,sa){var ta=n.get(),ua=na.getMaxTabsToShow(),va=n.indexOf(ra);n.closeTabAndDemote(ra,ua-2,sa);return va;}q.subscribe('selected',function(ra,sa){oa(sa);});g.subscribe('chat/open-tab',function(ra,sa){oa(sa.thread_id);});g.subscribe('page_transition',function(ra,sa){n.closeFragileTabs();});w.subscribe('model-update-completed',ia);if(!j.get('chat_mark_read_on_focus')){i.subscribe('activity',function(){na.checkWidth();ha();});na.subscribe('max-to-show-change-completed',function(){if(i.isActive())ha();});}else p.subscribe('focused',function(event,ra){fa(ra);});i.subscribe('idle',function(ra,sa){if(sa>da){var ta=n.get().tabs;ta.forEach(function(ua){var va=ua.id;y.getThreadMeta(va,function(wa){if(!wa.unread_count){ea.log('autoclose_idle_seen',{thread_id:va,idleness:sa});n.closeTab(va,'autoclose_idle_seen');}});});}});p.subscribe('nub-activated',function(ra,sa){oa(sa);});p.subscribe('lower-activated',function(ra,sa){n.lowerTab(sa);var ta=p.get(sa);ta&&ta.focus();fa(sa);});function qa(ra,sa){ca.showOutgoingCallDialog(sa.userID,sa.clickSource);n.lowerTab(sa.threadID);}p.subscribe('video-call-clicked',qa);m.subscribe('video-call-clicked',qa);p.subscribe('closed-tab',function(ra,sa){ea.log('close_view',{thread_id:sa});pa(sa,'close_view');fa(sa);return false;});p.subscribe('thread-deleted',function(ra,sa){ea.log('close_thread_deleted',{thread_id:sa});pa(sa,'close_thread_deleted');return false;});p.subscribe('unsubscribed',function(ra,sa){ea.log('close_view_unsubscribed',{thread_id:sa});pa(sa,'close_view_unsubscribed');return false;});p.subscribe('esc-pressed',function(ra,sa){ea.log('close_esc',{thread_id:sa});var ta=pa(sa,'close_esc');ja(ta-1,true,true)||ja(ta,false,true);});x.subscribe('messages-received',function(ra,sa){for(var ta in sa){var ua=sa[ta];for(var va=0;va<ua.length;va++){var wa=ua[va];if(wa.author!=v.user){if(!wa.is_unread){ea.log('message_already_read',{action_id:wa.action_id,thread_id:wa.thread_id});continue;}y.getThreadMeta(ta,function(xa){o.messageIsAllowed(xa,wa,function(){k.newMessage(ta,wa);});});}}}});x.subscribe('thread-read-changed',function(ra,sa){for(var ta in sa)if(!sa[ta].mark_as_read){ea.log('autoclose_marked_unread',{thread_id:ta});n.closeTab(ta,'autoclose_marked_unread');}});p.subscribe('tab-pressed',function(ra,sa){return !ja(n.indexOf(sa.id),sa.shiftPressed);});g.subscribe(t.DUMP_EVENT,function(ra,sa){sa.chat_controller={auto_close_timeout:da};});}if(ba.firefox()){var la=function(){return aa.get(document.body,'overflowX')+' '+aa.get(document.body,'overflowY');},ma=la();document.documentElement.addEventListener('DOMAttrModified',function(event){if(event.getTarget()===document.documentElement&&(event.attrName==='class'||event.attrName==='style')){var na=la();if(na!==ma){ma=na;g.inform('overflow-applied-to-body');}}},false);}e.exports=ka;});
__d("MercuryLiveListenHandler",["Arbiter","Bootloader","ChannelConstants","ChatSound","copyProperties","JSLogger","MercuryServerRequests","MusicConstants","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('Bootloader'),i=b('ChannelConstants'),j=b('ChatSound'),k=b('copyProperties'),l=b('JSLogger'),m=b('MercuryServerRequests'),n=b('MusicConstants'),o=a.MusicEvents,p=c('MercuryConstants'),q=l.create('live_listen_handler');function r(x,y,z,aa){var ba='live_listen:'+x.session_id,ca=x.session_id+':'+y+':'+z,da={action_id:null,action_type:p.MercuryActionType.LOG_MESSAGE,author:'fbid:'+y,folder:false,forward_count:0,is_unread:false,log_message_data:aa,log_message_type:p.MercuryLogMessageType.LIVE_LISTEN,message_id:ca,source:p.MercurySourceType.CHAT_WEB,thread_id:ba,threading_id:'',timestamp:z,timestamp_absolute:(new Date(z)).toLocaleString()},ea=p.MercuryPayloadSource.CLIENT_LIVE_LISTEN;m.handleUpdateWaitForThread({actions:[k({},da)],payload_source:ea},ba);}function s(x,y){q.log('end_session',{type:x,data:y});}function t(x,y){var z=y.actor,aa=y.session;if(aa&&z){q.log('listener_update',{type:x,data:y});var ba={actor:z,music_type:'listener_update'};r(aa,z.id,z.time*1000,ba);}}function u(x,y){var z=y.actor,aa=y.session;if(aa&&z&&z.time){q.log('begin_session',{type:x,data:y});var ba={actor:z,music_type:'begin_session'};r(aa,z.id,z.time*1000,ba);}}function v(x,y){var z=y.session,aa=y.song;if(z&&y.title&&y.body&&aa){q.log('play_error',{type:x,data:y});var ba={title:y.title,body:y.body,song:aa,music_type:'play_error'};r(z,z.leader,aa.published*1000,ba);}}function w(x,y){var z=y.session,aa=y.song?y.song:{};if(z&&aa.title&&aa.artist&&aa.artist_url&&aa.published&&aa.published>=z.creation_time){q.log('song_play',{type:x,data:y});var ba={title:aa.title,url:aa.url,artist:aa.artist,artist_url:aa.artist_url,music_type:'song'};r(z,z.leader,aa.published*1000,ba);}}o.subscribe([n.LIVE_LISTEN_OP.NOW_LEADING,n.LIVE_LISTEN_OP.NOW_LISTENING],u);o.subscribe([n.LIVE_LISTEN_OP.END_SESSION],s);o.subscribe([n.LIVE_LISTEN_OP.SONG_PLAYING],w);o.subscribe([n.LIVE_LISTEN_OP.LISTENER_UPDATE],t);o.subscribe([n.LIVE_LISTEN_OP.PLAY_ERROR],v);g.subscribe(i.getArbiterType('livelisten_update'),function(x,y){h.loadModules(['MusicLiveListen'],function(z){z.handleUpdate(y.obj);});});e.exports={};});
__d("MercuryStateCheck",["Arbiter","copyProperties","ChannelConnection","ChannelConstants","MercuryFolders","MercuryServerRequests","URI","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('ChannelConnection'),j=b('ChannelConstants'),k=b('MercuryFolders'),l=b('MercuryServerRequests'),m=b('URI'),n=c('MercuryConstants'),o=h(new g(),{initialize:function(){g.subscribe(j.ON_INVALID_HISTORY,p);i.subscribe(i.CONNECTED,function(q,r){if(!r.init)p();});}});function p(){var q;if(m.getRequestURI().getPath().search(/webmessenger/)!==-1){q=k.getSupportedFolders();}else q=[n.MessagingTag.INBOX];l.fetchMissedMessages(q);}o.initialize();e.exports=o;});
__d("ChatTabViewCoordinator",["Arbiter","ChatConfig","ChatTabModel","ChatTabView","ChatTabViewSelector","CSS","VideoCallCore"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChatConfig'),i=b('ChatTabModel'),j=b('ChatTabView'),k=b('ChatTabViewSelector'),l=b('CSS'),m=b('VideoCallCore');function n(o,p){var q=new k(o),r={},s=false;function t(){var y=i.get(),z={};y.tabs.forEach(function(ba){z[ba.id]=1;});for(var aa in r)if(!z[aa]){r[aa].destroy();delete(r[aa]);}u(y);v(y);}function u(y){var z=null;y.tabs.forEach(function(aa){var ba=aa.id,ca=false;if(!r[ba]){r[ba]=new j(ba,aa.server_id);ca=true;}if(ca||!r[ba].nextTabIs(z))if(z){r[ba].insertBefore(z);}else r[ba].appendTo(o);z=r[ba];});}function v(y){var z=p.getTabsToShow(y),aa=[],ba=false;y.tabs.forEach(function(ca){if(!z[ca.id]){r[ca.id].setVisibleState(false,ca.raised);aa.push(ca);}});y.tabs.forEach(function(ca){if(z[ca.id]){r[ca.id].setVisibleState(true,ca.raised);ba|=ca.raised;}});q.setTabData(aa);x(ba);}function w(y){for(var z=0,aa=y.tabs.length;z<aa;z++){var ba=y.tabs[z];if(ba.raised)if(ba.id===y.promoted||z<p.getMaxTabsToShow()-1)return true;}return false;}function x(y){if(!y&&s){g.inform('layer_hidden',{type:'ChatTab'});s=false;}else if(y&&!s){g.inform('layer_shown',{type:'ChatTab'});s=true;}}if(m.isSupported())l.addClass(o,'videoCallEnabled');p.subscribe('tabs-changed',t);t();}e.exports=n;});
__d("TabsViewport",["event-extensions","ArbiterMixin","ChatConfig","ChatTabModel","Class","CSS","Dock","DOM","Parent","Vector","areObjectsEqual","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ArbiterMixin'),h=b('ChatConfig'),i=b('ChatTabModel'),j=b('Class'),k=b('CSS'),l=b('Dock'),m=b('DOM'),n=b('Parent'),o=b('Vector'),p=b('areObjectsEqual'),q=b('copyProperties');function r(s){this._root=s;Event.listen(window,'resize',this._recalculateWidth.bind(this));l.subscribe('resize',this._recalculateWidth.bind(this));i.subscribe('chat/tabs-changed',this._recalculateTabs.shield(this,true));this._recalculateWidth();this._initialized=true;}q(r.prototype,g,{_root:null,_initialized:false,_availableWidth:0,_maxShown:1,_viewState:null,_recalculateWidth:function(){var s=r._getAvailableDockWidth(this._root),t=Math.max(1,Math.floor(s/264)),u=t!=this._maxShown;if(!this._viewState||u||s<=this._viewState.usedWidth||s>this._viewState.widthToShowNext){this._availableWidth=s;this._maxShown=t;this._viewState=null;this._recalculateTabs(u);}},_onTabsChanged:function(){if(this._initialized){this.inform('tabs-changed');this.inform('max-to-show-changed',this._maxShown);this.inform('max-to-show-change-completed');}},_recalculateTabs:function(s){var t=r._getTabsToShow(i.get(),this._availableWidth);if(s||!p(this._viewState,t)){this._viewState=t;this._onTabsChanged();}},getMaxTabsToShow:function(){return this._maxShown;},checkWidth:function(){this._recalculateWidth();},getTabsToShow:function(){return JSON.parse(JSON.stringify(this._viewState.tabsToShow));},shouldPromoteOnRaise:function(s){if(!this._viewState.tabsToShow[s])return true;if(this._viewState.nextToHide!=s)return false;var t=i.getTab(s),u=t&&t.raised;return !u&&(this._availableWidth-this._viewState.usedWidth<100);}});q(r,{_getAvailableDockWidth:function(s){var t=o.getViewportDimensions().x;t-=230;t-=50;var u=n.byClass(s,'fbDock'),v=o.getElementDimensions(u),w=n.byClass(s,'fbDockChat'),x=o.getElementDimensions(w),y=v.x-x.x;t-=y;t-=20;return Math.max(t,0);},_getTabsToShow:function(s,t){var u=164,v=264;t=Math.max(t,v+1);function w(la){return la.raised?v:u;}var x=JSON.parse(JSON.stringify(s.tabs)),y=-1,z=null;if(s.promoted)x.forEach(function(la,ma){if(la.id===s.promoted){y=ma;z=la;}});var aa=0,ba=0,ca=!z;x.forEach(function(la,ma){var na=w(la);la.leftmostOffset=aa+v;aa+=na;if(la.leftmostOffset<t)ba++;ca|=ma==y;la.alreadyPlacedPromoted=ca;});function da(la,ma,na){var oa={};for(var pa=0;pa<ma;pa++){var qa=la[pa];if(!qa.alreadyPlacedPromoted&&pa==ma-1){oa[na]=true;}else oa[qa.id]=true;}return oa;}var ea=da(x,ba,s.promoted),fa=da(x,ba-1,s.promoted),ga=null;for(var ha in ea)if(!fa[ha])ga=ha;var ia=x[ba-1],ja=ia?ia.leftmostOffset:0,ka=Infinity;if(ba<x.length)ka=x[ba].leftmostOffset;return {nextToHide:ga,tabsToShow:ea,usedWidth:ja,widthToShowNext:ka};}});e.exports=r;});
__d("ChatApp",["MercuryChannelHandler","ChatTabController","MercuryLiveListenHandler","MercuryStateCheck","ChatTabViewCoordinator","MercuryServerRequests","TabsViewport"],function(a,b,c,d,e,f){b('MercuryChannelHandler');b('ChatTabController');b('MercuryLiveListenHandler');b('MercuryStateCheck');var g=b('ChatTabController'),h=b('ChatTabViewCoordinator'),i=b('MercuryServerRequests'),j=b('TabsViewport');e.exports=function(k,l){i.handleUpdate(l);this.tabsViewport=new j(k);this.tabController=new g(this.tabsViewport);this.tabViewCoordinator=new h(k,this.tabsViewport);};});
__d("StickyArea",["event-extensions","ContextualLayer","CSS","DataStore","DOM","LayerHideOnTransition","Style","Vector","copyProperties","cx"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ContextualLayer'),h=b('CSS'),i=b('DataStore'),j=b('DOM'),k=b('LayerHideOnTransition'),l=b('Style'),m=b('Vector'),n=b('copyProperties'),o=b('cx');function p(r){var s=l.getScrollParent(r.parentNode);this.node=r;this._extracted=false;this._placeholder=j.create('div',{className:"-cx-PRIVATE-uiStickyArea__placeholder"});q.getInstance(s).register(this);}n(p.prototype,{update:function(){if(this._extracted){m.getElementDimensions(this._placeholder).setElementWidth(this.node);m.getElementDimensions(this.node).setElementHeight(this._placeholder);}else m.getElementDimensions(this.node).setElementWidth(this.node).setElementHeight(this._placeholder);return this;},setExtracted:function(r){if(r===this._extracted)return this;if(r){this.update();j.replace(this.node,this._placeholder);}else{l.set(this.node,'height',null);l.set(this.node,'width',null);j.replace(this._placeholder,this.node);}this._extracted=r;return this;},getOffsetTop:function(){return (this._extracted?this._placeholder:this.node).offsetTop;}});function q(r){this.node=r;this._areas=[];this._fixTarget=null;this._fixedArea=null;this._initialized=false;this._layer=new g({},j.create('div')).setInsertParent(this.node.parentNode).disableBehavior(k);this._listener=Event.listen(r,'scroll',this.update.bind(this));h.addClass(r,"-cx-PRIVATE-uiStickyArea__container");i.set(r,'StickyContainer',this);}q.getInstance=function(r){var s=i.get(r,'StickyContainer');return s||new q(r);};n(q.prototype,{isDisplayed:function(){return this.node.offsetParent!==null;},register:function(r){this._areas.push(r);return this;},update:function(){if(!this.isDisplayed())return this;var r=null,s=this,t=this.node.scrollTop;for(var u=0;u<this._areas.length;u++){var v=this._areas[u],w=v.getOffsetTop();if(w<=t){r=v;}else if(r){var x=m.getElementDimensions(r.node).y;if(w-x<t)s=v;break;}}this._init();if(this._fixedArea===r&&this._fixTarget===s){this._fixedArea&&this._fixedArea.update();}else{if(this._fixedArea&&this._fixedArea!==r)this._unfixArea(this._fixedArea);if(r)this._fixAreaTo(r,s);this._fixedArea=r;this._fixTarget=s;}return this;},destroy:function(){this._listener&&this._listener.remove();this._listener=null;},_init:function(){if(this._initialized)return;this._initialized=true;this._layer.updatePosition();},_fixAreaTo:function(r,s){this._layer.hide();r.setExtracted(true);if(s instanceof q){this._layer.setInsertParent(this.node.parentNode).setContext(this.node);}else this._layer.setInsertParent(this.node).setContext(s.node);this._layer.setContent(r.node).show();},_unfixArea:function(r){this._layer.hide();r.setExtracted(false);}});e.exports=p;});